<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soul Bloom | Mentor Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0c1a1e; color: #e2e8f0; }
        .font-playfair { font-family: 'Playfair Display', serif; }
        .glass { background: rgba(17, 24, 39, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        
        #garden-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none; }
        .leaf { position: absolute; width: 30px; height: 30px; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" fill="%2322c55e" viewBox="0 0 24 24"><path d="M17 8C8 10 5.9 16.17 3.82 21.34L5.71 22L6.66 19.7C7.14 18.45 7.93 17.37 8.95 16.54C10 15.64 11.22 15 12.5 15H17V12H12.5C11.54 12 10.64 11.73 9.84 11.23C9.04 10.73 8.36 10.05 7.85 9.24C7.05 7.94 6.75 6.45 7 5C7.25 3.55 8.06 2.22 9.24 1.28L10.47 2.5L9.5 3.47C9.06 3.91 8.72 4.45 8.5 5C8.25 5.55 8.12 6.16 8.12 6.79C8.12 7.41 8.25 8.03 8.5 8.5C8.72 9.05 9.06 9.59 9.5 10.03L10.47 11L17 11V8Z"/></svg>'); background-size: contain; opacity: 0.1; animation: float 20s infinite linear; }
        @keyframes float { 0% { transform: translateY(100vh) rotate(0deg); } 100% { transform: translateY(-20vh) rotate(360deg); } }
        
        /* Flatpickr Customization */
        .flatpickr-calendar { background: #1f2937 !important; border: 1px solid #374151 !important; box-shadow: 0 10px 25px rgba(0,0,0,0.5) !important; }
        .flatpickr-day.selected { background: #22c55e !important; border-color: #22c55e !important; }
        .flatpickr-time input:hover, .flatpickr-time .flatpickr-am-pm:hover { background: #374151 !important; }
        input[data-input] { cursor: text !important; }
        /* --- RICH CHAT & MEDIA STYLES --- */
        .custom-audio-player { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; border-radius: 0.5rem; background-color: rgba(0, 0, 0, 0.3); width: 100%; max-width: 250px; margin-top: 5px; }
        .audio-play-pause-btn { background-color: #4f46e5; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .audio-timeline-container { flex-grow: 1; height: 6px; background-color: rgba(255, 255, 255, 0.2); border-radius: 3px; cursor: pointer; position: relative; }
        .audio-timeline-progress { height: 100%; background-color: #4f46e5; border-radius: 3px; width: 0%; pointer-events: none; }
        .audio-time-display { font-family: monospace; font-size: 0.7rem; color: #A0AEC0; }
        .hidden-audio-element { display: none; }

        #attachment-menu { position: absolute; bottom: 100%; left: 0; margin-bottom: 0.5rem; padding: 0.5rem; border-radius: 0.5rem; transform-origin: bottom left; transition: all 0.2s ease-out; z-index: 60;}
       /* Base state - Always include these */
        #emoji-panel { 
            position: absolute; 
            bottom: 100%; 
            right: 0; 
            margin-bottom: 0.5rem; 
            width: 300px; 
            height: 300px; 
            border-radius: 0.5rem; 
            transform-origin: bottom right; 
            transition: all 0.2s ease-out; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            z-index: 60;
        }

        /* 1. Add this: When it has the 'hidden' class, hide it completely from clicks */
        #emoji-panel.hidden {
            opacity: 0;
            transform: scale(0.9);
            pointer-events: none; /* This is the key fix */
            display: none !important; /* Forces it off the screen */
        }

        /* 2. Add this: When it's NOT hidden, make sure clicks work */
        #emoji-panel:not(.hidden) {
            display: flex !important;
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }

        .emoji-tab { padding: 0.5rem 1rem; cursor: pointer; color: #949ba4; border-bottom: 2px solid transparent; }
        .emoji-tab.active { color: #ffffff; border-bottom-color: #4f46e5; }
        .emoji-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(32px, 1fr)); gap: 0.5rem; padding: 0.5rem; overflow-y: auto; }
        .emoji-btn, .sticker-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; border-radius: 4px; }
        .emoji-btn:hover, .sticker-btn:hover { background-color: rgba(255, 255, 255, 0.1); }
        .sticker-btn { font-size: 2.5rem; }

        #context-menu { position: fixed; z-index: 100; width: 220px; border-radius: 6px; padding: 0.5rem; opacity: 0; transform: scale(0.95); transition: opacity 0.1s ease-out; pointer-events: none; }
        #context-menu.show { opacity: 1; transform: scale(1); pointer-events: auto; }
        .context-menu-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; border-radius: 4px; font-weight: 500; cursor: pointer; }
        .context-menu-item:hover { background-color: rgba(255, 255, 255, 0.1); }
        .context-menu-item.danger:hover { background-color: #ef4444; color: white; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="garden-bg"></div>
    <div id="toast-container" class="fixed bottom-5 right-5 z-[9999] flex flex-col gap-2 pointer-events-none"></div>
    <style>
        /* Add this to your existing <style> block or header */
        .toast-enter { transform: translateX(100%); opacity: 0; }
        .toast-enter-active { transform: translateX(0); opacity: 1; transition: all 0.3s ease-out; }
        .toast-exit { transform: translateX(100%); opacity: 0; transition: all 0.3s ease-in; }
    </style>

    <header class="sticky top-0 z-50 w-full glass border-b border-white/10">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i data-lucide="sprout" class="w-8 h-8 text-green-400"></i>
                <div class="flex flex-col">
                    <span class="text-2xl font-bold font-playfair text-white">Soul Bloom</span>
                    <span class="text-xs font-sans text-blue-300">Logged in as: <span id="current-mentor-name">Loading...</span></span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button id="btn-clear" onclick="window.clearMockData()" class="hidden md:block bg-gray-600/20 border border-gray-500 text-gray-300 hover:bg-gray-600 hover:text-white px-3 py-1 rounded text-xs font-bold transition">
                    <i data-lucide="trash-2" class="w-3 h-3 inline mr-1"></i> Clear Data
                </button>
                <button onclick="window.simulateGraphData()" class="hidden md:block bg-blue-600/20 border border-blue-500 text-blue-300 hover:bg-blue-600 hover:text-white px-3 py-1 rounded text-xs font-bold transition">
                    + Simulate Reports
                </button>
                <button onclick="window.simulateFlag()" class="hidden md:block bg-red-600/20 border border-red-500 text-red-300 hover:bg-red-600 hover:text-white px-3 py-1 rounded text-xs font-bold transition">
                    + Simulate Alert
                </button>
                <button onclick="openAdminChat()" class="hidden md:flex items-center gap-2 bg-indigo-600/20 border border-indigo-500 text-indigo-300 hover:bg-indigo-600 hover:text-white px-3 py-1 rounded text-xs font-bold transition">
                    <i data-lucide="message-square" class="w-4 h-4"></i> Institute Server
                </button>
                <div class="flex items-center gap-2 text-sm text-green-400 bg-green-900/30 px-3 py-1 rounded-full border border-green-500/30">
                    <span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span></span>
                    <span class="hidden sm:inline">Live System</span>
                </div>
                <button onclick="logout()" class="bg-gray-700 hover:bg-red-600 text-white p-2 rounded-full transition-colors duration-300" title="Sign Out">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-6 flex-1">
        
        <div class="mb-8"><h1 class="text-3xl font-bold text-white mb-2">Campus Wellness Overview</h1><p class="text-gray-400">Real-time insights from student screenings and check-ins.</p></div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="glass rounded-xl p-6 border-l-4 border-blue-500"><h3 class="text-sm font-medium text-gray-400 uppercase tracking-wider">Total Reports</h3><p class="text-4xl font-bold text-white mt-2" id="stat-reports">Loading...</p><div class="text-xs text-blue-400 mt-2" id="stat-reports-label">Filtered View</div></div>
            <div class="glass rounded-xl p-6 border-l-4 border-yellow-500"><h3 class="text-sm font-medium text-gray-400 uppercase tracking-wider">Avg Anxiety Score</h3><p class="text-4xl font-bold text-white mt-2" id="stat-anxiety">...</p><div class="text-xs text-yellow-400 mt-2">Based on GAD-7</div></div>
            <div class="glass rounded-xl p-6 border-l-4 border-green-500"><h3 class="text-sm font-medium text-gray-400 uppercase tracking-wider">Avg Mood Score</h3><p class="text-4xl font-bold text-white mt-2" id="stat-mood">...</p><div class="text-xs text-green-400 mt-2">Inverse PHQ-9 metric</div></div>
            <div class="glass rounded-xl p-6 border-l-4 border-red-500"><h3 class="text-sm font-medium text-gray-400 uppercase tracking-wider">Active Alerts</h3><p class="text-4xl font-bold text-white mt-2" id="stat-alerts">...</p><div class="text-xs text-red-400 mt-2" id="alert-subtext">Requires attention</div></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <div class="lg:col-span-2 glass rounded-xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-white">Student Mental Health Distribution</h3>
                    <select id="time-filter" onchange="window.filterAnalytics(this.value)" class="bg-black/30 border border-white/10 rounded px-3 py-1 text-sm text-gray-300 focus:outline-none focus:border-green-500 cursor-pointer">
                        <option value="today">Today</option>
                        <option value="7days">Last 7 Days</option>
                        <option value="30days" selected>Last 30 Days</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
                <div class="h-64"><canvas id="wellnessChart"></canvas></div>
            </div>

            <div class="glass rounded-xl p-6 flex flex-col h-full gap-6">
                <div class="flex-1 flex flex-col min-h-0">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2"><i data-lucide="calendar" class="w-5 h-5 text-blue-400"></i> Schedule</h3>
                    </div>
                    <div id="appointments-list" class="flex-1 overflow-y-auto space-y-3 max-h-48 pr-1"><p class="text-gray-500 text-sm italic">Loading schedule...</p></div>
                </div>
                <div class="border-t border-white/10 pt-4 space-y-4">
                    <div>
                        <label class="text-xs text-blue-300 block mb-1 font-bold">Open Appointment Slot</label>
                        <div class="flatpickr-wrapper flex gap-2 relative">
                            <input type="text" id="appt-date" data-input placeholder="2025 10 20 14 00 (Press Enter)" class="w-full bg-black/40 border border-white/10 rounded px-2 py-1 text-xs text-white focus:outline-none focus:border-blue-500 cursor-text">
                            <button type="button" data-toggle class="absolute right-14 top-1 text-gray-400 hover:text-white transition cursor-pointer"><i data-lucide="calendar-days" class="w-5 h-5"></i></button>
                            <button onclick="addAppointmentSlot()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded text-xs font-bold transition">Add</button>
                        </div>
                        <p id="appt-msg" class="text-[10px] text-green-400 mt-1 hidden">Slot Added!</p>
                    </div>
                    <div>
                        <label class="text-xs text-purple-300 block mb-1 font-bold">Manage Resources</label>
                        <input type="text" id="res-title" placeholder="Title" class="w-full bg-black/40 border border-white/10 rounded px-2 py-1 text-xs text-white mb-2 focus:outline-none focus:border-purple-500">
                        <div class="flex gap-2 mb-3">
                            <input type="text" id="res-url" placeholder="https://..." class="w-full bg-black/40 border border-white/10 rounded px-2 py-1 text-xs text-white focus:outline-none focus:border-purple-500">
                            <button onclick="addResource()" class="bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded text-xs font-bold transition">Add</button>
                        </div>
                        <p id="res-msg" class="text-[10px] text-green-400 mt-1 hidden">Resource Added!</p>
                        
                        <div class="text-xs text-gray-400 uppercase font-bold mb-2 mt-4 border-t border-white/10 pt-2">Current Resources</div>
                        <div id="resources-list" class="space-y-2 max-h-32 overflow-y-auto pr-1">
                            <p class="text-[10px] text-gray-600 italic">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="glass rounded-xl p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-red-400 flex items-center gap-2"><i data-lucide="shield-alert" class="w-5 h-5"></i> Flagged Content Review</h3>
                
                <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-400 uppercase">Filter:</span>
                    <select id="flag-filter" onchange="window.renderFlags()" class="bg-black/30 border border-white/10 rounded px-3 py-1 text-xs text-gray-300 focus:outline-none focus:border-red-500 cursor-pointer">
                        <option value="all">All Priorities</option>
                        <option value="high">üî¥ High Only</option>
                        <option value="medium">üü† Medium Only</option>
                        <option value="low">üü° Low Only</option>
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="text-xs text-gray-400 uppercase bg-black/20 border-b border-white/10">
                        <tr>
                            <th class="px-4 py-3 w-10">Prio</th> <th class="px-4 py-3">Timestamp</th>
                            <th class="px-4 py-3">User ID</th>
                            <th class="px-4 py-3">Trigger Content</th>
                            <th class="px-4 py-3">Action</th>
                        </tr>
                    </thead>
                    <tbody id="flagged-table-body" class="text-sm text-gray-300 divide-y divide-white/5">
                        <tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Connecting to live feed...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <div id="report-viewer-section" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[100]">
        <div class="bg-gray-900 rounded-lg border border-gray-700 shadow-2xl max-w-2xl w-full p-6 m-4 relative">
            <button onclick="document.getElementById('report-viewer-section').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            <div class="mb-4 border-b border-gray-700 pb-4"><h2 class="text-xl font-bold text-white flex items-center gap-2"><i data-lucide="file-text" class="w-5 h-5 text-blue-400"></i> Student Health Report</h2></div>
            <div id="single-report-content" class="space-y-4"></div>
        </div>
    </div>

    <div id="resolve-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-[110]">
        <div class="glass max-w-md w-full p-6 rounded-2xl border border-red-500/30 shadow-[0_0_50px_rgba(220,38,38,0.2)]">
            <div class="flex items-center gap-3 mb-4 text-red-400 border-b border-white/10 pb-4"><div class="p-2 bg-red-500/20 rounded-lg"><i data-lucide="siren" class="w-6 h-6"></i></div><h2 class="text-xl font-bold">Crisis Resolution Center</h2></div>
            <p class="text-sm text-gray-400 mb-6">Select an immediate action for Student <span id="res-student-id" class="text-white font-mono">...</span></p>
            <div class="space-y-3">
                <button onclick="performAction('remind')" class="w-full flex items-center justify-between p-4 rounded-xl bg-gray-800 hover:bg-gray-700 border border-white/10 transition-all group">
                    <div class="flex items-center gap-3"><div class="p-2 bg-blue-500/20 rounded-lg text-blue-400"><i data-lucide="bell-ring" class="w-5 h-5"></i></div><div class="text-left"><div class="font-bold text-gray-200">Send Check-in Reminder</div><div class="text-xs text-gray-500">Nudge student to update journal</div></div></div><i data-lucide="chevron-right" class="w-4 h-4 text-gray-600 group-hover:text-white"></i>
                </button>
                <button onclick="toggleBookingInput()" class="w-full flex items-center justify-between p-4 rounded-xl bg-gray-800 hover:bg-gray-700 border border-white/10 transition-all group">
                    <div class="flex items-center gap-3"><div class="p-2 bg-purple-500/20 rounded-lg text-purple-400"><i data-lucide="calendar-check" class="w-5 h-5"></i></div><div class="text-left"><div class="font-bold text-gray-200">Book Priority Session</div><div class="text-xs text-gray-500">Schedule immediate 1:1 meeting</div></div></div><i data-lucide="chevron-down" class="w-4 h-4 text-gray-600 group-hover:text-white"></i>
                </button>
                <div id="booking-input-area" class="hidden p-4 rounded-xl bg-gray-800/50 border border-purple-500/30">
                    <label class="text-xs text-purple-300 block mb-2">Select Date & Time:</label>
                    <div class="priority-picker flex gap-2 relative mb-3">
                        <input type="text" id="priority-date-input" data-input placeholder="2025 10 20 14 00" class="w-full bg-black/40 border border-white/10 rounded px-3 py-2 text-sm text-white mb-3 focus:outline-none focus:border-purple-500 cursor-text">
                        <button type="button" data-toggle class="absolute right-3 top-2 text-purple-400 hover:text-white cursor-pointer"><i data-lucide="calendar-days" class="w-5 h-5"></i></button>
                    </div>
                    <button onclick="performAction('book')" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded text-sm font-bold transition">Confirm Booking</button>
                </div>
                <button onclick="performAction('resolve')" class="w-full flex items-center justify-between p-4 rounded-xl bg-gray-800 hover:bg-green-900/30 border border-white/10 hover:border-green-500/50 transition-all group">
                    <div class="flex items-center gap-3"><div class="p-2 bg-green-500/20 rounded-lg text-green-400"><i data-lucide="check-circle-2" class="w-5 h-5"></i></div><div class="text-left"><div class="font-bold text-gray-200 group-hover:text-green-300">Mark as Resolved</div><div class="text-xs text-gray-500 group-hover:text-green-400/70">Archive & Remove from Stats</div></div></div><i data-lucide="chevron-right" class="w-4 h-4 text-gray-600 group-hover:text-white"></i>
                </button>
            </div>
            <button onclick="closeResolveModal()" class="mt-6 w-full py-2 text-sm text-gray-500 hover:text-white transition">Cancel</button>
        </div>
    </div>

    <div id="reschedule-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-[120]">
        <div class="glass max-w-sm w-full p-6 rounded-2xl border border-blue-500/30">
            <h3 class="text-lg font-bold text-white mb-4">Reschedule Appointment</h3>
            <label class="text-xs text-blue-300 block mb-2">Select New Date & Time:</label>
            <div class="reschedule-picker flex gap-2 relative mb-4">
                <input type="text" id="reschedule-date-input" data-input placeholder="2025 10 20 14 00" class="w-full bg-black/40 border border-white/10 rounded px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500 cursor-text">
                <button type="button" data-toggle class="absolute right-3 top-2 text-blue-400 hover:text-white cursor-pointer"><i data-lucide="calendar-days" class="w-5 h-5"></i></button>
            </div>
            <div class="flex gap-2">
                <button onclick="confirmReschedule()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded text-sm font-bold">Update</button>
                <button onclick="document.getElementById('reschedule-modal').classList.add('hidden')" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2 rounded text-sm">Cancel</button>
            </div>
        </div>
    </div>
    <div id="chat-drawer" class="fixed inset-y-0 right-0 w-96 bg-gray-900 border-l border-white/10 shadow-2xl transform translate-x-full transition-transform duration-300 z-50 flex flex-col">
        <div class="p-4 border-b border-white/10 flex justify-between items-center bg-gray-800">
            <div>
                <h3 class="text-white font-bold text-lg" id="chat-student-name">Student Chat</h3>
                <span class="text-xs text-green-400 flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Live Connection
                </span>
            </div>
            <button onclick="toggleChat(false)" class="text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
        </div>

        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-900/50">
            <div class="text-center text-gray-500 text-sm mt-10">Loading conversation...</div>
        </div>

        <div class="p-4 border-t border-white/10 bg-gray-800">
            <form onsubmit="event.preventDefault(); window.sendMessage();" class="flex gap-2">
                <input type="text" id="chat-input" placeholder="Type a message..." 
                    class="flex-1 bg-gray-700 text-white border-none rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-500 text-white p-2 rounded-lg transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                </button>
            </form>
        </div>
    </div>
    <div id="institute-chat-overlay" class="fixed inset-0 z-50 bg-gray-900 hidden flex flex-col">
    
        <div class="bg-gray-800 p-2 flex justify-between items-center border-b border-white/10">
            <div class="flex items-center gap-2">
                <span class="text-green-400 text-xl">üõ°Ô∏è</span>
                <h2 class="text-white font-bold">Institute Server (Admin Mode)</h2>
            </div>
            <button onclick="document.getElementById('institute-chat-overlay').classList.add('hidden')" 
                    class="bg-red-600 hover:bg-red-500 text-white px-4 py-1 rounded text-sm font-bold">
                Close Server
            </button>
        </div>

        <div id="chat-view" class="w-full flex-1 flex overflow-hidden">
            
            <div id="channel-list-panel" class="w-64 bg-gray-800 border-r border-white/10 flex flex-col">
                <div class="p-4 shadow-md">
                    <h2 class="text-gray-400 text-xs uppercase font-bold tracking-wider">Channels</h2>
                </div>
                
                <div id="channel-buttons-container" class="flex-1 p-3 space-y-2 overflow-y-auto">
                    </div>

                <div id="user-panel" class="p-3 bg-gray-900/50 flex items-center gap-3 border-t border-white/5">
                    <div class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-lg">üõ°Ô∏è</div>
                    <div class="overflow-hidden">
                        <span id="chat-user-name" class="block font-bold text-white text-sm truncate">Mentor</span>
                        <span class="block text-xs text-indigo-400">Admin Privileges</span>
                    </div>
                </div>
            </div>

            <div id="chat-area" class="flex-1 flex flex-col bg-gray-900 relative">
                
                <div id="main-chat-header" class="flex items-center justify-between p-4 border-b border-white/10 h-16 bg-gray-800/50">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl text-gray-400">#</span>
                        <h3 id="current-channel-name" class="text-white font-bold text-lg">Select a Channel</h3>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-4 space-y-4" id="main-chat-messages">
                    <div class="flex flex-col items-center justify-center h-full text-gray-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 opacity-20 mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                        <p>Select a channel to moderate</p>
                    </div>
                </div>

                <div id="main-chat-input-wrapper" class="hidden p-4 pt-0 bg-gray-900">
                    <div id="voice-recorder-container"></div>
                    <div id="main-chat-input-container" class="bg-gray-800 border border-white/10 rounded-lg p-2 flex items-center gap-2 relative">
                        
                        <div id="attachment-menu" class="bg-gray-800 border border-white/10 shadow-xl hidden scale-90 opacity-0">
                            <div class="flex flex-col gap-2">
                                <button id="attach-image-btn" class="context-menu-item text-gray-300"><i data-lucide="image" class="w-4 h-4"></i> Image</button>
                                <button id="attach-doc-btn" class="context-menu-item text-gray-300"><i data-lucide="file-text" class="w-4 h-4"></i> Document</button>
                                <button id="record-voice-btn" class="context-menu-item text-gray-300"><i data-lucide="mic" class="w-4 h-4"></i> Record Voice</button>
                            </div>
                        </div>
                        
                        <button id="attachment-btn" class="p-2 text-gray-400 hover:text-white transition-transform"><i data-lucide="plus-circle" class="w-5 h-5"></i></button>
                        
                        <input type="text" id="main-chat-input" placeholder="Message as Admin..." class="flex-1 bg-transparent text-white border-none outline-none px-2 placeholder-gray-500">
                        
                        <button id="emoji-btn" class="p-2 text-gray-400 hover:text-white"><i data-lucide="smile" class="w-5 h-5"></i></button>
                        <button id="main-chat-send-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white p-2 rounded-md transition-colors"><i data-lucide="send" class="w-4 h-4"></i></button>

                        <div id="emoji-panel" class="bg-gray-800 border border-white/10 shadow-xl hidden scale-90 opacity-0">
                            <div class="flex border-b border-white/10">
                                <button class="emoji-tab active text-sm" data-tab="emojis">Emojis</button>
                                <button class="emoji-tab text-sm" data-tab="stickers">Stickers</button>
                            </div>
                            <div id="emojis-grid" class="emoji-grid flex-1"></div>
                            <div id="stickers-grid" class="emoji-grid flex-1 hidden"></div>
                        </div>
                    </div>
                </div>

                <div id="context-menu" class="bg-gray-800 border border-white/10 shadow-2xl"></div>

                <div id="image-preview-modal" class="fixed inset-0 bg-black/80 flex-col items-center justify-center hidden z-[100] p-4">
                    <img id="preview-image" src="" alt="Preview" class="max-w-full max-h-[70vh] object-contain rounded-lg shadow-2xl">
                    <div class="flex gap-2 mt-4 w-full max-w-lg">
                        <input type="text" id="image-caption-input" placeholder="Add a caption..." class="flex-1 bg-gray-800 text-white p-3 rounded-lg border border-white/20 outline-none focus:border-indigo-500">
                        <button id="send-image-btn" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-indigo-500">Send</button>
                        <button id="cancel-image-btn" class="bg-gray-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-gray-500">Cancel</button>
                    </div>
                </div>
                <input type="file" id="image-upload-input" class="hidden" accept="image/*">
                <input type="file" id="doc-upload-input" class="hidden" accept=".pdf,.doc,.docx,.txt,.md">

            </div>
        </div>
    </div>
    <script type="module">
        import { getFirestore, doc, getDoc, setDoc, collection, query, onSnapshot, getDocs, where, addDoc, deleteDoc, deleteField, updateDoc, serverTimestamp, orderBy, limit, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBq0HjzNJxwBrRGpn3TXFdUiOK-ye5fl44",
            authDomain: "soulbloom-5ee07.firebaseapp.com",
            projectId: "soulbloom-5ee07",
            storageBucket: "soulbloom-5ee07.firebasestorage.app",
            messagingSenderId: "713116806966",
            appId: "1:713116806966:web:2f0ca2b5a4736f5816cd97",
            measurementId: "G-17068CTD2S"
        };

        const sanitizedAppId = 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // GLOBALS
        let allReports = []; 
        let allFlags = []; 
        let currentFlagId = null;
        let currentStudentId = null;
        let currentRescheduleId = null; 
        
        // MENTOR IDENTITY (New Feature)
        window.currentMentor = { id: null, name: "Staff Member" };

        // --- INIT FLATPICKR ---
        document.addEventListener('DOMContentLoaded', () => {
            const commonConfig = { enableTime: true, dateFormat: "Y-m-d H:i", minDate: "today", time_24hr: false, allowInput: true, clickOpens: false, wrap: true };
            const fp1 = flatpickr(".flatpickr-wrapper", commonConfig);
            const fp2 = flatpickr(".priority-picker", commonConfig);
            const fp3 = flatpickr(".reschedule-picker", commonConfig);
            
            function setupSmartInput(inputSelector, fpInstance) {
                const input = document.querySelector(inputSelector);
                if(!input) return;
                input.addEventListener("keydown", function(e) {
                    if (e.key === "Enter") {
                        e.preventDefault(); 
                        const raw = input.value.trim();
                        const regex = /^(\d{4})[\s\/-]?(\d{1,2})[\s\/-]?(\d{1,2})[\sT-]?(\d{1,2})[\s:-]?(\d{1,2})$/;
                        const match = raw.match(regex);
                        if (match) {
                            const cleanDate = `${match[1]}-${match[2].padStart(2,'0')}-${match[3].padStart(2,'0')} ${match[4].padStart(2,'0')}:${match[5].padStart(2,'0')}`;
                            fpInstance.setDate(cleanDate, true); 
                            input.style.borderColor = "#22c55e"; setTimeout(() => input.style.borderColor = "rgba(255,255,255,0.1)", 1000);
                        } else {
                            input.style.borderColor = "#ef4444"; setTimeout(() => input.style.borderColor = "rgba(255,255,255,0.1)", 1000);
                        }
                    }
                });
            }
            setupSmartInput("#appt-date", fp1);
            setupSmartInput("#priority-date-input", fp2);
            setupSmartInput("#reschedule-date-input", fp3);
        });

        // --- TOAST NOTIFICATIONS (Helper) ---
        window.showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            if(!container) {
                const c = document.createElement('div');
                c.id = 'toast-container';
                c.className = "fixed bottom-5 right-5 z-[9999] flex flex-col gap-2 pointer-events-none";
                document.body.appendChild(c);
            }
            const el = document.createElement('div');
            const bgClass = type === 'error' ? 'bg-red-600' : (type === 'info' ? 'bg-blue-600' : 'bg-green-600');
            const icon = type === 'error' ? 'alert-circle' : (type === 'info' ? 'info' : 'check-circle');
            el.className = `${bgClass} text-white px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 min-w-[300px] toast-enter pointer-events-auto transition-all duration-300`;
            el.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5"></i><span class="font-medium text-sm">${message}</span>`;
            document.getElementById('toast-container').appendChild(el);
            lucide.createIcons({ nodes: [el] });
            
            // Animation
            setTimeout(() => { el.style.transform = "translateX(0)"; el.style.opacity = "1"; }, 10);
            
            // Remove
            setTimeout(() => { 
                el.style.transform = "translateX(100%)"; 
                el.style.opacity = "0"; 
                setTimeout(() => el.remove(), 300); 
            }, 3000);
        };

        // --- AUTH & PROFILE (Updated: Auto-Name, No Prompt) ---
        async function ensureMentorProfile(user) {
            currentMentor.id = user.uid;
            const profileRef = doc(db, `artifacts/${sanitizedAppId}/public/data/profiles/${user.uid}`);
            const snap = await getDoc(profileRef);

            if (snap.exists()) {
                // CASE 1: Returning User - Load existing name
                const data = snap.data();
                currentMentor.name = data.name || "Mentor";
                
                if (data.role === 'student') {
                     window.showToast("Warning: Student account detected.", "error");
                }
            } else {
                // CASE 2: First Time User - Auto-generate name (No Prompt)
                
                // Try getting name from Google Auth
                let name = user.displayName;
                
                // If not found, generate "Dr. [EmailName]" from email
                if (!name && user.email) {
                    const emailName = user.email.split('@')[0]; // Get text before @
                    // Capitalize first letter (e.g., "sarah" -> "Sarah")
                    const formattedName = emailName.charAt(0).toUpperCase() + emailName.slice(1);
                    name = `Dr. ${formattedName}`;
                }
                
                // Fallback
                if (!name) name = "Staff Member";
                
                // Save to database silently
                await setDoc(profileRef, {
                    name: name,
                    role: 'mentor',
                    email: user.email || 'anon',
                    joinedAt: serverTimestamp()
                });
                currentMentor.name = name;
                window.showToast(`Welcome, ${name}!`, "success");
            }
            
            // Update the header display
            const headerNameEl = document.getElementById('current-mentor-name');
            if(headerNameEl) headerNameEl.innerText = currentMentor.name;
        }

        // --- 1. ANALYTICS ---
        async function fetchAnalytics() {
            try {
                const reportsRef = collection(db, `artifacts/${sanitizedAppId}/public/data/mental_health_reports`);
                onSnapshot(reportsRef, (snapshot) => {
                    allReports = [];
                    snapshot.forEach(doc => allReports.push({ id: doc.id, ...doc.data() })); 
                    const currentFilter = document.getElementById('time-filter').value;
                    filterAnalytics(currentFilter);
                    window.renderFlags(); 
                });
            } catch (e) { console.error("Analytics Error:", e); }
        }

        window.filterAnalytics = (range) => {
            if (!allReports.length) {
                document.getElementById('stat-reports').innerText = "0";
                document.getElementById('stat-anxiety').innerText = "0.0";
                document.getElementById('stat-mood').innerText = "-";
                updateChart({ normal: 0, mild: 0, moderate: 0, severe: 0 });
                return;
            }
            const now = new Date();
            let cutoffDate = new Date(0); 
            if (range === 'today') { cutoffDate = new Date(); cutoffDate.setHours(0, 0, 0, 0); } 
            else if (range === '7days') { cutoffDate.setDate(now.getDate() - 7); } 
            else if (range === '30days') { cutoffDate.setDate(now.getDate() - 30); }

            const filteredData = allReports.filter(r => {
                if (!r.createdAt) return false;
                const rDate = r.createdAt.toDate ? r.createdAt.toDate() : new Date(r.createdAt);
                return rDate >= cutoffDate;
            });
            processStats(filteredData);
        };

        function processStats(data) {
            let totalPHQ = 0, totalGAD = 0;
            let severity = { normal: 0, mild: 0, moderate: 0, severe: 0 };
            if (data.length === 0) {
                document.getElementById('stat-reports').innerText = "0";
                document.getElementById('stat-anxiety').innerText = "0.0"; 
                document.getElementById('stat-mood').innerText = "-";
                updateChart(severity);
                return;
            }
            data.forEach(r => {
                const p = r.phqScore || 0;
                totalPHQ += p;
                totalGAD += (r.gadScore || 0);
                if (p < 5) severity.normal++;
                else if (p < 10) severity.mild++;
                else if (p < 15) severity.moderate++;
                else severity.severe++;
            });
            const total = data.length;
            const avgPHQ = total > 0 ? (totalPHQ / total).toFixed(1) : 0;
            const avgGAD = total > 0 ? (totalGAD / total).toFixed(1) : 0;
            document.getElementById('stat-reports').innerText = total;
            document.getElementById('stat-anxiety').innerText = avgGAD; 
            document.getElementById('stat-mood').innerText = total > 0 ? (27 - avgPHQ).toFixed(1) : "-";
            updateChart(severity);
        }

        let wellnessChartInstance = null;
        function updateChart(data) {
            const ctx = document.getElementById('wellnessChart').getContext('2d');
            if(wellnessChartInstance) wellnessChartInstance.destroy();
            wellnessChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Thriving', 'Mild Stress', 'Moderate', 'Critical'],
                    datasets: [{
                        label: 'Student Count',
                        data: [data.normal, data.mild, data.moderate, data.severe],
                        backgroundColor: ['rgba(34, 197, 94, 0.6)', 'rgba(234, 179, 8, 0.6)', 'rgba(249, 115, 22, 0.6)', 'rgba(239, 68, 68, 0.6)'],
                        borderColor: ['rgb(34, 197, 94)', 'rgb(234, 179, 8)', 'rgb(249, 115, 22)', 'rgb(239, 68, 68)'],
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#9ca3af' } }, x: { grid: { display: false }, ticks: { color: '#9ca3af' } } } }
            });
        }

        // --- 3. FLAGGED USERS ---
        // --- FINAL & STABLE: Integrated Flags Listener ---
        function listenForFlags() {
            // 1. Safety Check: If mentor identity isn't loaded yet, don't run the query.
            if (!currentMentor || !currentMentor.id) {
                console.warn("Mentor ID not found. Retrying flag listener...");
                return; 
            }

            const flagsRef = collection(db, `artifacts/${sanitizedAppId}/public/data/flagged_users`);
            
            // We keep the sort and limit for performance.
            const q = query(flagsRef, orderBy('timestamp', 'desc'), limit(30)); 

            onSnapshot(q, (snapshot) => {
                try {
                    allFlags = [];
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        
                        // CLAIM LOGIC:
                        // Show if: 1. No one has claimed it OR 2. I am the one who claimed it.
                        const isUnclaimed = !data.assignedMentorId;
                        const isMine = data.assignedMentorId === currentMentor.id;

                        if (isUnclaimed || isMine) {
                            allFlags.push({ id: doc.id, ...data });
                        }
                    });

                    // Re-render the table UI
                    if (typeof window.renderFlags === 'function') {
                        window.renderFlags();
                    }
                    
                    // Update the Batch counter if the element exists
                    const batchCounter = document.getElementById('stat-batch');
                    if (batchCounter) {
                        const myActiveCases = allFlags.filter(f => f.assignedMentorId === currentMentor.id).length;
                        batchCounter.innerText = myActiveCases;
                    }
                } catch (err) {
                    console.error("Error processing flag snapshot:", err);
                }
            }, (error) => {
                // --- CRITICAL: Check your F12 Console for a link here ---
                console.error("Firestore Listener Error:", error);
                if (error.message.includes("requires an index")) {
                    console.warn("ACTION REQUIRED: Click the link in the console error above to create the Firestore Index.");
                }
            });
        }

        window.renderFlags = () => {
            // 1. Get Global ID
            const myID = window.currentMentor ? window.currentMentor.id : null;
            const tbody = document.getElementById('flagged-table-body');
            const filterVal = document.getElementById('flag-filter').value;
            
            // Combine Data Sources
            const criticalReports = allReports
                .filter(r => (r.phqScore >= 15 || r.gadScore >= 15) && !r.isGraphOnly) 
                .map(r => ({
                    id: 'screen_' + r.id, 
                    userId: r.userId,
                    priority: 'high',
                    message: `CRITICAL SCREENING: PHQ-9: ${r.phqScore}, GAD-7: ${r.gadScore}`,
                    timestamp: r.createdAt,
                    isReport: true,
                    realReportId: r.id,
                    // Preserve assignment info if it exists on the report
                    assignedMentorId: r.assignedMentorId || null,
                    assignedMentorName: r.assignedMentorName || null
                }));

            let combinedData = [...allFlags, ...criticalReports];

            // Sort by Time
            combinedData.sort((a, b) => {
                const timeA = a.timestamp?.seconds || (a.timestamp?.toDate ? a.timestamp.toDate().getTime()/1000 : 0);
                const timeB = b.timestamp?.seconds || (b.timestamp?.toDate ? b.timestamp.toDate().getTime()/1000 : 0);
                return timeB - timeA;
            });

            // Filter by Priority
            const filtered = combinedData.filter(f => {
                if (filterVal === 'all') return true;
                return f.priority === filterVal;
            });

            // Update Stats & Empty State
            const statAlerts = document.getElementById('stat-alerts');
            if (statAlerts) statAlerts.innerText = filtered.length; 
            
            if (filtered.length === 0) { 
                tbody.innerHTML = `<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">No flags match this filter.</td></tr>`; 
                return; 
            }

            let html = '';
            
            filtered.forEach(d => {
                let actionButtons = '';
                
                // --- LOGIC: Check Ownership ---
                const isUnclaimed = !d.assignedMentorId;
                const isMine = d.assignedMentorId === myID;

                if (isUnclaimed) {
                    // 1. Unclaimed -> Show CLAIM
                    actionButtons = `
                        <button onclick="window.claimAlert('${d.id}')" 
                                class="bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded text-[10px] font-bold uppercase transition-all active:scale-95 shadow-lg shadow-green-900/20">
                            Claim Alert
                        </button>`;
                } else if (isMine) {
                    // Case B: I own it -> Show UNCLAIM / MESSAGE / VIEW / RESOLVE
                    actionButtons = `
                        <div class="flex gap-2 justify-end items-center">
                            
                            <button onclick="window.unclaimAlert('${d.id}')" title="Release" class="text-yellow-400 hover:text-yellow-300 mr-2"><i data-lucide="rotate-ccw" class="w-4 h-4"></i></button>

                            <button onclick="window.openChat('${d.userId}')" 
                                    class="bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 rounded text-[10px] font-bold uppercase flex items-center gap-1">
                                Chat
                            </button>

                            <button onclick="window.checkReport('${d.userId}')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-2 py-1 rounded text-[10px] font-bold uppercase">View</button>
                            
                            <button onclick="window.openResolveModal('${d.id}', '${d.userId}')" class="bg-red-600 hover:bg-red-500 text-white px-2 py-1 rounded text-[10px] font-bold uppercase">Resolve</button>
                        </div>`;
                } else {
                    // 3. Claimed by OTHERS -> Show Text
                    actionButtons = `<span class="text-gray-500 text-[10px] italic">Claimed by ${d.assignedMentorName || 'others'}</span>`;
                }

                // formatting dates and colors
                let dateStr = 'Just now';
                if (d.timestamp?.toDate) dateStr = d.timestamp.toDate().toLocaleString();
                else if (d.timestamp instanceof Date) dateStr = d.timestamp.toLocaleString();
                
                let dotColor = 'bg-gray-500';
                if(d.priority === 'high') dotColor = 'bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.6)]';
                else if(d.priority === 'medium') dotColor = 'bg-orange-500';
                else if(d.priority === 'low') dotColor = 'bg-yellow-500';

                // --- HTML GENERATION ---
                html += `
                    <tr class="hover:bg-white/5 transition border-b border-white/5 group" id="row-${d.id}">
                        <td class="px-4 py-3"><div class="w-3 h-3 rounded-full ${dotColor} mx-auto" title="Priority: ${d.priority}"></div></td>
                        <td class="px-4 py-3 text-gray-400 font-mono text-xs">${dateStr}</td>
                        <td class="px-4 py-3 font-mono text-xs text-blue-300">
                            <div class="flex items-center gap-2">
                                ${isMine ? '<div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>' : ''}
                                ${d.userId ? d.userId.substring(0,8) : 'Unknown'}...
                            </div>
                        </td>
                        <td class="px-4 py-3 text-gray-200 italic max-w-xs truncate" title="${d.message}">"${d.message}"</td>
                        
                        <td class="px-4 py-3 text-right">
                            ${actionButtons}
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        };
        // --- 4. APPOINTMENTS ---
        // --- CONSOLIDATED: Private Appointments Listener with Student Info ---
        function listenForAppointments() {
            // 1. Safety Check: If mentor identity isn't loaded yet, wait.
            if (!currentMentor.id) {
                console.log("Waiting for mentor ID to load private schedule...");
                // Re-call this function once mentor is set in onAuthStateChanged
                return; 
            }

            const apptRef = collection(db, `artifacts/${sanitizedAppId}/public/data/appointments`);
            
            // 2. The Private Query: 
            // Filter by current mentor's ID so you only see your specific sessions.
            // Note: You MUST check the console and click the link to create an index if it's the first time.
            const q = query(
                apptRef, 
                where("mentorId", "==", currentMentor.id),
                orderBy("startTime", "asc")
            );

            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('appointments-list');
                if (!list) return;

                const appts = [];
                snapshot.forEach(doc => appts.push({ id: doc.id, ...doc.data() }));
                
                // Handle Empty State
                if (appts.length === 0) { 
                    list.innerHTML = `<p class="text-gray-500 text-xs text-center py-4 italic">No sessions scheduled for you.</p>`; 
                    return; 
                }
                
                list.innerHTML = '';
                
                appts.forEach(a => {
                    const date = a.startTime?.toDate ? a.startTime.toDate() : new Date();
                    const isPriority = a.status === 'booked' && (a.mentorName || '').includes('Priority');
                    const isBooked = a.status === 'booked';
                    
                    // UI Logic: Border colors and Status labels
                    const borderClass = isPriority ? 'border-l-4 border-red-500' : (isBooked ? 'border-l-4 border-blue-500' : 'border-l-4 border-gray-500');
                    const statusText = isPriority ? 'Priority Session' : (isBooked ? 'Booked' : 'Open Slot');
                    
                    // --- Feature: Show Student ID if booked ---
                    let studentInfoHTML = '';
                    if (isBooked && a.studentId) {
                        studentInfoHTML = `
                            <div class="mt-1 flex items-center gap-1.5 bg-blue-900/20 px-2 py-1 rounded border border-blue-500/20 w-fit">
                                <i data-lucide="user" class="w-3 h-3 text-blue-400"></i>
                                <span class="text-xs text-blue-200 font-mono" title="${a.studentId}">
                                    Student ID: ${a.studentId.substring(0, 8)}...
                                </span>
                            </div>
                        `;
                    } else if (isBooked) {
                        studentInfoHTML = `<div class="mt-1 text-xs text-gray-500 italic">Booked (Anonymous)</div>`;
                    }

                    const div = document.createElement('div');
                    div.className = `p-3 bg-white/5 rounded ${borderClass} flex justify-between items-center group relative mb-2`;
                    
                    div.innerHTML = `
                        <div>
                            <div class="text-sm font-bold text-gray-200">
                                ${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                            </div>
                            <div class="text-xs text-gray-400">${statusText}</div>
                            ${studentInfoHTML}
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <div class="flex gap-1 ml-2">
                                <button onclick="window.rescheduleAppt('${a.id}')" title="Reschedule" class="p-1 text-gray-500 hover:text-blue-400 transition">
                                    <i data-lucide="clock" class="w-4 h-4"></i>
                                </button>
                                <button onclick="window.cancelAppt('${a.id}')" title="Cancel" class="p-1 text-gray-500 hover:text-red-400 transition">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    list.appendChild(div);
                });
                
                // Refresh Lucide icons for the new elements
                if (window.lucide) window.lucide.createIcons();
                
            }, (error) => {
                // --- CRITICAL: Handle Firestore Index Requirement ---
                console.error("Firestore Query Error:", error);
                if (error.message.includes("requires an index")) {
                    const container = document.getElementById('appointments-list');
                    container.innerHTML = `<p class="text-red-400 text-[10px] p-2 bg-red-900/10 rounded">Database Index required. Please check developer console to create it.</p>`;
                    console.warn("Follow the link in the error above to build the composite index for mentorId and startTime.");
                }
            });
        }
        
        window.addAppointmentSlot = async () => {
            const dateVal = document.getElementById('appt-date').value;
            if(!dateVal) return window.showToast("Please select a date/time", "error");
            
            const newSlotTime = new Date(dateVal);
            const bufferMinutes = 30;

            // Calculate the 30-minute window (Before and After)
            const minBuffer = new Date(newSlotTime.getTime() - bufferMinutes * 60000);
            const maxBuffer = new Date(newSlotTime.getTime() + bufferMinutes * 60000);

            try {
                const apptRef = collection(db, `artifacts/${sanitizedAppId}/public/data/appointments`);
                
                // Query: Any slot for THIS mentor where startTime is within the buffer window
                const clashQuery = query(
                    apptRef, 
                    where("mentorId", "==", currentMentor.id),
                    where("startTime", ">", Timestamp.fromDate(minBuffer)),
                    where("startTime", "<", Timestamp.fromDate(maxBuffer))
                );

                const clashSnap = await getDocs(clashQuery);

                if (!clashSnap.empty) {
                    // Find the clashing slot time for a helpful message
                    const clashingSlot = clashSnap.docs[0].data();
                    const clashingTime = clashingSlot.startTime.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    window.showToast(`Schedule conflict! Too close to your ${clashingTime} session.`, "error");
                    document.getElementById('appt-date').style.borderColor = "#ef4444";
                    return; 
                }

                // Proceed with creation if no clash
                await addDoc(collection(db, `artifacts/${sanitizedAppId}/public/data/appointments`), {
                    startTime: newSlotTime,
                    status: 'open', 
                    mentorName: currentMentor.name,
                    mentorId: currentMentor.id,
                    createdAt: serverTimestamp()
                });

                document.getElementById('appt-date').value = '';
                document.getElementById('appt-date').style.borderColor = "rgba(255,255,255,0.1)";
                window.showToast("Slot successfully added to your schedule.", "success");

            } catch(e) { 
                console.error("Slot Error:", e); 
                window.showToast("Error checking schedule availability", "error"); 
            }
        };

        window.rescheduleAppt = (id) => { currentRescheduleId = id; document.getElementById('reschedule-modal').classList.remove('hidden'); };
        window.confirmReschedule = async () => {
            const dateInput = document.getElementById('reschedule-date-input').value;
            if(!dateInput || !currentRescheduleId) return window.showToast("Select a time.", "error");
            try { await updateDoc(doc(db, `artifacts/${sanitizedAppId}/public/data/appointments/${currentRescheduleId}`), { startTime: new Date(dateInput) }); document.getElementById('reschedule-modal').classList.add('hidden'); currentRescheduleId = null; window.showToast("Rescheduled!", "success"); } catch(e) { console.error(e); window.showToast("Error rescheduling", "error"); }
        };
        window.cancelAppt = async (id) => { if(!confirm("Cancel this session?")) return; try { await deleteDoc(doc(db, `artifacts/${sanitizedAppId}/public/data/appointments/${id}`)); window.showToast("Session Cancelled", "info"); } catch(e) { console.error(e); window.showToast("Error deleting", "error"); } }

        // --- 5. VIEW REPORT ---
        window.checkReport = async (userId) => {
            const reportsRef = collection(db, `artifacts/${sanitizedAppId}/public/data/mental_health_reports`);
            const q = query(reportsRef, where("userId", "==", userId)); 
            const snapshot = await getDocs(q);
            const contentDiv = document.getElementById('single-report-content');
            const modal = document.getElementById('report-viewer-section');
            if (!snapshot.empty) {
                const docs = snapshot.docs.map(d => d.data());
                docs.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                const data = docs[0];
                const reportDate = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString() : 'N/A';
                const phqColor = data.phqScore >= 15 ? 'text-red-500' : (data.phqScore >= 10 ? 'text-yellow-400' : 'text-green-400');
                const gadColor = data.gadScore >= 15 ? 'text-red-500' : (data.gadScore >= 10 ? 'text-yellow-400' : 'text-green-400');
                contentDiv.innerHTML = `<div class="grid grid-cols-2 gap-4 text-sm text-gray-300 mb-4 bg-black/20 p-3 rounded"><div><strong>User ID:</strong> <span class="font-mono text-blue-300">${data.userId}</span></div><div><strong>Date:</strong> ${reportDate}</div></div><div class="grid grid-cols-2 gap-4 text-sm mb-4"><div class="bg-black/40 p-3 rounded border border-white/5"><span class="text-gray-400 block text-xs uppercase mb-1">Depression (PHQ-9)</span><span class="font-bold text-xl ${phqColor}">${data.phqScore}</span> / 27</div><div class="bg-black/40 p-3 rounded border border-white/5"><span class="text-gray-400 block text-xs uppercase mb-1">Anxiety (GAD-7)</span><span class="font-bold text-xl ${gadColor}">${data.gadScore}</span> / 21</div></div><div class="bg-black/40 p-4 rounded text-gray-300 text-sm whitespace-pre-wrap border-l-2 border-blue-500">${data.report}</div>`;
            } else { contentDiv.innerHTML = `<div class="text-center py-8"><p class="text-yellow-400 mb-2">No screening report found.</p><p class="text-xs text-gray-500">Likely Chat Analysis Flag.</p></div>`; }
            modal.classList.remove('hidden');
        };

        // --- 6. RESOLUTION ---
        window.openResolveModal = (flagId, userId) => {
            currentFlagId = flagId;
            currentStudentId = userId;
            document.getElementById('res-student-id').innerText = userId.substring(0, 8) + '...';
            document.getElementById('resolve-modal').classList.remove('hidden');
            document.getElementById('booking-input-area').classList.add('hidden');
        };
        window.closeResolveModal = () => { document.getElementById('resolve-modal').classList.add('hidden'); currentFlagId = null; currentStudentId = null; };
        window.toggleBookingInput = () => { document.getElementById('booking-input-area').classList.toggle('hidden'); };

        window.performAction = async (actionType) => {
            if (!currentStudentId || !currentFlagId) return;
            try {
                if (actionType === 'remind') {
                    await addDoc(collection(db, `artifacts/${sanitizedAppId}/users/${currentStudentId}/notifications`), {
                        title: "Wellness Check-in", 
                        message: `${currentMentor.name} noticed you might be stressed. Please fill out your journal today.`, // <--- REAL NAME
                        type: "reminder", 
                        createdAt: serverTimestamp()
                    });
                    window.showToast("Notification Sent!", "success");
                    window.closeResolveModal();
                } else if (actionType === 'book') {
                    const dateInput = document.getElementById('priority-date-input').value;
                    if(!dateInput) { window.showToast("Please select a date/time.", "error"); return; }
                    
                    await addDoc(collection(db, `artifacts/${sanitizedAppId}/public/data/appointments`), {
                        startTime: new Date(dateInput), 
                        status: 'booked', 
                        mentorName: `${currentMentor.name} (Priority)`, // <--- REAL NAME
                        mentorId: currentMentor.id,
                        studentId: currentStudentId, 
                        createdAt: serverTimestamp()
                    });
                    window.showToast("Priority Session Booked!", "success");
                    window.closeResolveModal();
                } else if (actionType === 'resolve') {
                    if (currentFlagId.startsWith('screen_')) {
                        const realReportId = currentFlagId.split('screen_')[1];
                        await deleteDoc(doc(db, `artifacts/${sanitizedAppId}/public/data/mental_health_reports/${realReportId}`));
                    } else {
                        const flagRef = doc(db, `artifacts/${sanitizedAppId}/public/data/flagged_users/${currentFlagId}`);
                        const flagSnap = await getDoc(flagRef);
                        if (flagSnap.exists() && flagSnap.data().linkedReportId) {
                            await deleteDoc(doc(db, `artifacts/${sanitizedAppId}/public/data/mental_health_reports/${flagSnap.data().linkedReportId}`));
                        }
                        await deleteDoc(flagRef);
                    }
                    window.showToast("Alert Resolved.", "success");
                    window.closeResolveModal();
                }
            } catch (e) { console.error("Action Error:", e); window.showToast("Action Failed", "error"); }
        };

        // --- 7. RESOURCES ---
        function listenForResources() {
            const resRef = collection(db, `artifacts/${sanitizedAppId}/public/data/resources`);
            onSnapshot(query(resRef, orderBy('createdAt', 'desc')), (snapshot) => {
                const list = document.getElementById('resources-list');
                const items = [];
                snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
                
                if (items.length === 0) { list.innerHTML = `<p class="text-[10px] text-gray-600 italic">No resources yet.</p>`; return; }

                list.innerHTML = '';
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center bg-white/5 p-2 rounded border border-white/5";
                    div.innerHTML = `
                        <div class="overflow-hidden">
                            <div class="text-xs text-purple-300 font-bold truncate">${item.title}</div>
                            <div class="text-[10px] text-gray-500 truncate">${item.url}</div>
                        </div>
                        <button onclick="window.deleteResource('${item.id}')" class="text-gray-600 hover:text-red-500 transition ml-2">
                            <i data-lucide="trash-2" class="w-3 h-3"></i>
                        </button>
                    `;
                    list.appendChild(div);
                });
                lucide.createIcons();
            });
        }

        window.addResource = async () => {
            const title = document.getElementById('res-title').value;
            const url = document.getElementById('res-url').value;
            if(!title || !url) return window.showToast("Please fill in both fields.", "error");
            try {
                await addDoc(collection(db, `artifacts/${sanitizedAppId}/public/data/resources`), {
                    title: title, url: url, type: 'link', createdAt: serverTimestamp()
                });
                document.getElementById('res-title').value = ""; document.getElementById('res-url').value = "";
                window.showToast("Resource Added!", "success");
            } catch(e) { console.error(e); window.showToast("Error adding resource", "error"); }
        };

        window.deleteResource = async (id) => {
            if(!confirm("Remove this resource link?")) return;
            try {
                await deleteDoc(doc(db, `artifacts/${sanitizedAppId}/public/data/resources/${id}`));
                window.showToast("Resource Removed.", "info");
            } catch(e) { console.error(e); window.showToast("Error removing resource", "error"); }
        };

        // --- 8. SIMULATION TOOLS (Restored Fully) ---
        window.simulateFlag = async () => {
            const severities = [
                { type: 'Critical', priority: 'high', phq: 22, gad: 19, msg: "I can't take this anymore. Everything is too much." },
                { type: 'Moderate', priority: 'medium', phq: 12, gad: 11, msg: "Feeling extremely anxious about my upcoming exams." },
                { type: 'Mild', priority: 'low', phq: 7, gad: 6, msg: "Just feeling a bit down lately, not sure why." }
            ];
            const scenario = severities[Math.floor(Math.random() * severities.length)];
            const mockUserId = "test-user-" + Math.floor(Math.random()*1000);
            try {
                // 1. Create Report (Always, so graph updates)
                const reportRef = await addDoc(collection(db, `artifacts/${sanitizedAppId}/public/data/mental_health_reports`), { 
                    userId: mockUserId, 
                    phqScore: scenario.phq, 
                    gadScore: scenario.gad, 
                    report: `Auto-generated report for ${scenario.type} simulated alert.`, 
                    createdAt: serverTimestamp()
                });

                // 2. If Low/Medium, Create Manual Flag AND Link it to the Report
                if (scenario.priority !== 'high') {
                    await addDoc(collection(db, `artifacts/${sanitizedAppId}/public/data/flagged_users`), { 
                        userId: mockUserId, 
                        message: scenario.msg, 
                        priority: scenario.priority, 
                        timestamp: serverTimestamp(),
                        linkedReportId: reportRef.id 
                    });
                }
                window.showToast("Simulation Created!", "info");
            } catch(e) { console.error(e); }
        };

        window.simulateGraphData = async () => {
            const batchSize = 30;
            const reportsRef = collection(db, `artifacts/${sanitizedAppId}/public/data/mental_health_reports`);
            alert("Generating 30 mock reports... The graphs will update in a few seconds.");
            for (let i = 0; i < batchSize; i++) {
                const rand = Math.random();
                let phq, gad;
                if (rand > 0.8) { phq = 15 + Math.floor(Math.random() * 10); gad = 15 + Math.floor(Math.random() * 6); } 
                else if (rand > 0.5) { phq = 8 + Math.floor(Math.random() * 7); gad = 8 + Math.floor(Math.random() * 7); } 
                else { phq = Math.floor(Math.random() * 5); gad = Math.floor(Math.random() * 5); }
                const date = new Date();
                date.setDate(date.getDate() - Math.floor(Math.random() * 30));
                try {
                    await addDoc(reportsRef, { 
                        userId: `mock-student-${Math.floor(Math.random() * 9000)}`, 
                        phqScore: phq, 
                        gadScore: gad, 
                        report: "Simulated Data for Demo purposes.", 
                        createdAt: Timestamp.fromDate(date),
                        isGraphOnly: true 
                    });
                } catch(e) { console.log("Simulate error", e); }
            }
        };

        window.clearMockData = async () => {
            if (!confirm("Delete simulated data?")) return;
            const btn = document.getElementById('btn-clear');
            const originalText = btn.innerHTML;
            btn.innerHTML = `Cleaning...`;
            btn.disabled = true;
            try {
                const reportsRef = collection(db, `artifacts/${sanitizedAppId}/public/data/mental_health_reports`);
                const qReports = query(reportsRef, where("userId", ">=", "mock-student-"), where("userId", "<=", "mock-student-\uf8ff"));
                const snapReports = await getDocs(qReports);
                const deleteReportPromises = snapReports.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deleteReportPromises);

                const qTest = query(reportsRef, where("userId", ">=", "test-user-"), where("userId", "<=", "test-user-\uf8ff"));
                const snapTest = await getDocs(qTest);
                const deleteTestPromises = snapTest.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deleteTestPromises);

                const alertsRef = collection(db, `artifacts/${sanitizedAppId}/public/data/flagged_users`);
                const qAlerts = query(alertsRef, where("userId", ">=", "test-user-"), where("userId", "<=", "test-user-\uf8ff"));
                const snapAlerts = await getDocs(qAlerts);
                const deleteAlertPromises = snapAlerts.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deleteAlertPromises);

                window.showToast(`Cleared data!`, "success");
                allReports = []; 
                fetchAnalytics(); 
            } catch(e) { console.error("Clear Error:", e); } 
            finally { btn.innerHTML = originalText; btn.disabled = false; }
        };
        
        window.logout = async () => { 
            // Delete the profile from the database BEFORE signing out so it doesn't leave a ghost
            if (auth.currentUser) {
                try {
                    const profileRef = doc(db, `artifacts/${sanitizedAppId}/public/data/profiles/${auth.currentUser.uid}`);
                    await deleteDoc(profileRef);
                } catch (e) {
                    console.error("Error cleaning up profile before logout:", e);
                }
            }
            
            // Sign out and redirect
            auth.signOut().then(() => window.location.href = '../index.html'); 
        }
        // --- MODERATION LOGIC ---
        let targetUserId = null;

        window.openModerationMenu = (uid, display) => {
            if (!uid) return;
            targetUserId = uid;
            document.getElementById('mod-user-display').innerText = display;
            document.getElementById('mod-user-id').innerText = uid;
            document.getElementById('mod-menu').classList.remove('hidden');
            
            // Refresh icons inside the modal
            if (window.lucide) {
                lucide.createIcons({
                    nodes: [document.getElementById('mod-menu')]
                });
            }
        };

        window.closeModMenu = () => {
            document.getElementById('mod-menu').classList.add('hidden');
            targetUserId = null;
        };

        window.applyTimeout = async (minutes) => {
            if (!targetUserId) return;
            
            // Calculate the end time
            const timeoutDate = new Date();
            timeoutDate.setMinutes(timeoutDate.getMinutes() + minutes);
            
            try {
                // Reference the student's profile in Firestore
                // Note: sanitizedAppId and db must be defined in your script
                const profileRef = doc(db, `artifacts/${sanitizedAppId}/public/data/profiles/${targetUserId}`);
                
                await updateDoc(profileRef, {
                    timeoutUntil: timeoutDate.toISOString(),
                    isMuted: true
                });
                
                // Show a success notification
                if (window.showToast) {
                    showToast(`User ${targetUserId.slice(-4)} timed out for ${minutes}m`, "warning");
                }
                
                closeModMenu();
            } catch (err) {
                console.error("Timeout Error:", err);
                alert("Failed to apply timeout. Check permissions.");
            }
        };

        onAuthStateChanged(auth, (user) => { 
            if(user) { 
                ensureMentorProfile(user); // REAL LOGIN
                fetchAnalytics(); 
                listenForFlags(); 
                listenForAppointments();
                listenForResources();
                const bg = document.getElementById('garden-bg'); for(let i=0; i<15; i++) { const leaf = document.createElement('div'); leaf.className = 'leaf'; leaf.style.left = Math.random() * 100 + 'vw'; leaf.style.animationDuration = (15 + Math.random() * 15) + 's'; leaf.style.animationDelay = (Math.random() * 10) + 's'; bg.appendChild(leaf); } 
            } else { signInAnonymously(auth).catch(e => console.error(e)); } 
        });
        lucide.createIcons();
        window.claimAlert = async (fullId) => {
            try {
                let docRef;

                // 1. CHECK: Is this a Critical Report (Red Alert)?
                if (fullId.startsWith('screen_')) {
                    // Remove the 'screen_' prefix to get the real ID
                    const realId = fullId.replace('screen_', '');
                    
                    // TARGET THE REPORTS COLLECTION
                    // (If your collection is named 'screenings', change 'reports' to 'screenings' below)
                    docRef = doc(db, `artifacts/${sanitizedAppId}/public/data/mental_health_reports/${realId}`);
                } 
                // 2. OTHERWISE: It's a Standard Flag (Yellow Alert)
                else {
                    docRef = doc(db, `artifacts/${sanitizedAppId}/public/data/flagged_users/${fullId}`);
                }

                // 3. UPDATE: Claim it
                await updateDoc(docRef, {
                    assignedMentorId: window.currentMentor.id,
                    assignedMentorName: window.currentMentor.name,
                    claimedAt: serverTimestamp()
                });

                window.showToast("Case claimed successfully!", "success");

            } catch (e) {
                console.error("Claim Error:", e);
                // Specialized error message
                if (e.code === 'not-found') {
                    window.showToast("Error: Document not found. Check if collection name is 'reports' or 'screenings'.", "error");
                } else {
                    window.showToast("Someone else might have just claimed this.", "error");
                }
            }
        };
        // --- UNCLAIM ALERT (Release back to pool) ---
        window.unclaimAlert = async (fullId) => {
            if (!confirm("Release this case back to the pool?")) return;

            try {
                let docRef;

                if (fullId.startsWith('screen_')) {
                    const realId = fullId.replace('screen_', '');
                    docRef = doc(db, `artifacts/${sanitizedAppId}/public/data/mental_health_reports/${realId}`);
                } else {
                    docRef = doc(db, `artifacts/${sanitizedAppId}/public/data/flagged_users/${fullId}`);
                }
                
                // Remove the assignment fields
                await updateDoc(docRef, {
                    assignedMentorId: deleteField(),
                    assignedMentorName: deleteField(),
                    claimedAt: deleteField()
                });

                window.showToast("Case released.", "success");
            } catch (e) {
                console.error("Unclaim Error:", e);
                window.showToast("Error releasing case.", "error");
            }
        };
        // --- CHAT SYSTEM LOGIC ---
        let activeChatListener = null; // To store the unsubscribe function
        let currentChatId = null;      // To know which chat is open

        // 1. Open the Chat Drawer
        window.openChat = async (studentId) => {
            const drawer = document.getElementById('chat-drawer');
            const title = document.getElementById('chat-student-name');
            
            // UI: Slide in
            drawer.classList.remove('translate-x-full');
            title.innerText = `Chat: ${studentId.substring(0,8)}...`;
            
            // LOGIC: Create a unique Chat ID (MentorID_StudentID)
            // This ensures a private channel between YOU and THIS STUDENT
            currentChatId = `${window.currentMentor.id}_${studentId}`;
            
            // Start listening for messages
            listenForChatMessages(currentChatId);
        };

        // 2. Close/Toggle Drawer
        window.toggleChat = (show) => {
            const drawer = document.getElementById('chat-drawer');
            if (show) drawer.classList.remove('translate-x-full');
            else {
                drawer.classList.add('translate-x-full');
                // Stop listening when closed to save data
                if (activeChatListener) activeChatListener(); 
                currentChatId = null;
            }
        };

        // 3. Listen for Real-Time Messages
        function listenForChatMessages(chatId) {
            // Unsubscribe from previous chat if open
            if (activeChatListener) activeChatListener();

            const messagesRef = collection(db, `artifacts/${sanitizedAppId}/public/data/chats/${chatId}/messages`);
            const q = query(messagesRef, orderBy('timestamp', 'asc'), limit(50));

            activeChatListener = onSnapshot(q, (snapshot) => {
                const chatContainer = document.getElementById('chat-messages');
                chatContainer.innerHTML = ''; // Clear previous

                if (snapshot.empty) {
                    chatContainer.innerHTML = '<div class="text-center text-gray-500 text-xs italic mt-4">Start the conversation...</div>';
                    return;
                }

                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const isMe = msg.senderId === window.currentMentor.id;
                    
                    // Render Message Bubble
                    const bubble = document.createElement('div');
                    bubble.className = `flex ${isMe ? 'justify-end' : 'justify-start'}`;
                    bubble.innerHTML = `
                        <div class="max-w-[80%] rounded-lg p-3 text-sm ${isMe ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-gray-700 text-gray-200 rounded-bl-none'}">
                            <p>${msg.text}</p>
                            <div class="text-[10px] opacity-50 text-right mt-1">
                                ${msg.timestamp?.toDate ? msg.timestamp.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : 'Sending...'}
                            </div>
                        </div>
                    `;
                    chatContainer.appendChild(bubble);
                });

                // Auto-scroll to bottom
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        }

        // 4. Send a Message
        window.sendMessage = async () => {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text || !currentChatId) return;

            try {
                input.value = ''; // Clear input immediately
                
                // A. Add message to sub-collection
                const messagesRef = collection(db, `artifacts/${sanitizedAppId}/public/data/chats/${currentChatId}/messages`);
                await addDoc(messagesRef, {
                    text: text,
                    senderId: window.currentMentor.id,
                    senderName: window.currentMentor.name,
                    timestamp: serverTimestamp()
                });

                // B. Update the main Chat Document (for the list view later)
                const chatRef = doc(db, `artifacts/${sanitizedAppId}/public/data/chats/${currentChatId}`);
                await setDoc(chatRef, {
                    lastMessage: text,
                    lastUpdated: serverTimestamp(),
                    participants: [window.currentMentor.id, currentChatId.split('_')[1]], // [MentorID, StudentID]
                    mentorName: window.currentMentor.name
                }, { merge: true });

            } catch (e) {
                console.error("Send Error:", e);
                window.showToast("Failed to send message", "error");
            }
        };
        // =====================================================================
        // --- MENTOR CHAT & MEDIA INTEGRATION ---
        // =====================================================================
        window.openAdminChat = () => {
            document.getElementById('institute-chat-overlay').classList.remove('hidden');
            
            // Load channels when opened
            if (typeof loadAdminChannels === 'function') {
                loadAdminChannels(); 
            }
            
            // Set Mentor Name in Sidebar
            const mentorName = window.currentMentor ? window.currentMentor.name : "Staff";
            const nameEl = document.getElementById('chat-user-name');
            if(nameEl) nameEl.innerText = mentorName;
        };
        let currentChannelId = null;
        let msgListener = null;
        let unsubscribeFromChannels = null;

        // 1. Dynamic Channel Loading & Context Menu
        // 1. Dynamic Channel Loading & Context Menu (HYBRID VERSION)
        function loadAdminChannels() {
            if (unsubscribeFromChannels) unsubscribeFromChannels();
            const channelsRef = collection(db, `artifacts/${sanitizedAppId}/public/data/chatrooms`);
            
            unsubscribeFromChannels = onSnapshot(channelsRef, (snapshot) => {
                const container = document.getElementById('channel-buttons-container');
                if (!container) return; // Safety check
                
                container.innerHTML = ''; 

                // 1. Your Base Hardcoded Channels
                const baseChannels = [
                    { id: 'notices', name: 'Notices', icon: 'üì¢' }, 
                    { id: 'general-chat', name: 'General Chat', icon: 'üí¨' },
                    { id: 'gurashish-ka-channel', name: 'Gurashish ka Channel', icon: '#' },
                    { id: 'qna', name: 'Q&A Support', icon: '‚ùì' }
                ];

                // 2. Fetch any newly created channels from the database
                let dbChannels = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // 3. Merge them (Prevent duplicates if the base channels also exist in DB)
                let allChannels = [...baseChannels];
                dbChannels.forEach(dbChan => {
                    if (!allChannels.find(c => c.id === dbChan.id)) {
                        allChannels.push(dbChan);
                    }
                });

                // 4. Render all channels
                allChannels.forEach(channel => {
                    const btn = document.createElement('button');
                    btn.className = "channel-btn w-full text-left p-3 rounded-lg hover:bg-white/10 flex items-center gap-3 text-gray-300 transition-colors mb-1";
                    btn.dataset.channelId = channel.id;
                    btn.dataset.roomName = channel.name;
                    
                    // If it's an emoji (like üì¢ or ‚ùì), render as text. If it's a lucide icon (like 'hash'), render the SVG.
                    const isEmoji = ['üì¢', 'üí¨', '#', '‚ùì'].includes(channel.icon);
                    const iconHTML = isEmoji ? `<span>${channel.icon}</span>` : `<i data-lucide="${channel.icon || 'hash'}" class="w-5 h-5"></i>`;
                    
                    btn.innerHTML = `${iconHTML}<span class="font-medium truncate">${channel.name}</span>`;
                    
                    btn.onclick = () => {
                        document.querySelectorAll('.channel-btn').forEach(b => b.classList.remove('bg-white/10', 'text-white'));
                        btn.classList.add('bg-white/10', 'text-white');
                        switchAdminChannel(channel.id, channel.name);
                    };
                    container.appendChild(btn);
                });
                
                if(window.lucide) lucide.createIcons();
            });

            // Right Click for Channels (Add/Delete)
            const contextMenu = document.getElementById('context-menu');
            const channelsContainer = document.getElementById('channel-buttons-container');
            
            if (channelsContainer && contextMenu) {
                channelsContainer.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    const target = e.target.closest('.channel-btn');
                    
                    let html = `<div class="context-menu-item" onclick="createNewChannel()"><i data-lucide="plus" class="w-4 h-4"></i> Create Channel</div>`;
                    
                    // Prevent deleting the base hardcoded channels
                    const protectedIds = ['notices', 'general-chat', 'gurashish-ka-channel', 'qna'];
                    if (target && !protectedIds.includes(target.dataset.channelId)) {
                        html += `<div class="context-menu-item danger mt-1" onclick="deleteAdminChannel('${target.dataset.channelId}')"><i data-lucide="trash-2" class="w-4 h-4"></i> Delete Channel</div>`;
                    }
                    
                    contextMenu.innerHTML = html;
                    if(window.lucide) lucide.createIcons();
                    contextMenu.style.left = `${e.pageX}px`;
                    contextMenu.style.top = `${e.pageY}px`;
                    contextMenu.classList.add('show');
                });
                
                document.addEventListener('click', () => contextMenu.classList.remove('show'));
            }
        }
        // 2. Channel Management Functions
        window.createNewChannel = async () => {
            const name = prompt("Enter new channel name:");
            if (!name) return;
            const id = name.toLowerCase().replace(/\s+/g, '-');
            try {
                await setDoc(doc(db, `artifacts/${sanitizedAppId}/public/data/chatrooms/${id}`), {
                    name: name, id: id, icon: 'üí¨', createdAt: serverTimestamp()
                });
                window.showToast("Channel created!", "success");
            } catch(e) {
                console.error("Create channel error", e);
                window.showToast("Failed to create channel.", "error");
            }
        };

        window.deleteAdminChannel = async (id) => {
            if(confirm("Delete this channel? All messages will be lost.")) {
                try {
                    await deleteDoc(doc(db, `artifacts/${sanitizedAppId}/public/data/chatrooms/${id}`));
                    document.getElementById('main-chat-messages').innerHTML = '';
                    document.getElementById('current-channel-name').innerText = 'Select a Channel';
                    document.getElementById('main-chat-input-wrapper').classList.add('hidden');
                    window.showToast("Channel deleted.", "info");
                } catch(e) {
                    console.error("Delete channel error", e);
                    window.showToast("Failed to delete channel.", "error");
                }
            }
        };

        // 3. Switch Channel & Enable Admin Input
        function switchAdminChannel(channelId, channelName) {
            currentChannelId = channelId;
            const headerName = document.getElementById('current-channel-name');
            const inputWrapper = document.getElementById('main-chat-input-wrapper');
            const input = document.getElementById('main-chat-input');

            if (headerName) headerName.innerText = channelName;
            if (inputWrapper) inputWrapper.classList.remove('hidden'); 
            
            if (input) {
                if (channelId === 'notices') {
                    input.placeholder = "Post a Public Notice...";
                    input.classList.add("border-orange-500");
                } else {
                    input.placeholder = `Message #${channelName} as Admin...`;
                    input.classList.remove("border-orange-500");
                }
            }
            listenToAdminMessages(channelId);
        }

        // 4. Universal Send Message Function (Handles Text, Images, Audio, etc.)
        window.sendAdminMessageData = async (dataObj) => {
            if (!currentChannelId || !auth.currentUser) return;
            try {
                const payload = {
                    ...dataObj,
                    senderId: auth.currentUser.uid,
                    username: window.currentMentor ? window.currentMentor.name : "Staff",
                    role: "owner", // Forces the Shield/Crown on student side
                    createdAt: serverTimestamp()
                };
                await addDoc(collection(db, `artifacts/${sanitizedAppId}/public/data/chatrooms/${currentChannelId}/messages`), payload);
            } catch (e) { 
                console.error("Send Error:", e); 
                if(window.showToast) window.showToast("Failed to send media", "error");
            }
        };

        // Delete Message
        window.deleteStudentMessage = async (channelId, msgId) => {
            if (!confirm("Are you sure you want to delete this message?")) return;
            try {
                await deleteDoc(doc(db, `artifacts/${sanitizedAppId}/public/data/chatrooms/${channelId}/messages`, msgId));
                if(window.showToast) window.showToast("Message deleted", "success");
            } catch (e) { console.error(e); }
        };

        // 5. Listen for Messages (With Rich Media Support)
        function listenToAdminMessages(channelId) {
            if (msgListener) msgListener(); 
            const q = query(
                collection(db, `artifacts/${sanitizedAppId}/public/data/chatrooms/${channelId}/messages`),
                orderBy('createdAt', 'asc'), 
                limit(100)
            );

            msgListener = onSnapshot(q, (snapshot) => {
                const container = document.getElementById('main-chat-messages');
                if (!container) return;
                
                container.innerHTML = '';

                if (snapshot.empty) {
                    container.innerHTML = '<div class="text-center text-gray-500 mt-10">No messages yet.</div>';
                }

                snapshot.forEach(docSnap => {
                    const msg = docSnap.data();
                    const isMe = msg.senderId === auth.currentUser.uid; 
                    const timeObj = msg.createdAt?.toDate ? msg.createdAt.toDate() : null;
                    const timeStr = timeObj ? timeObj.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
                    
                    const deleteBtn = `
                        <button onclick="deleteStudentMessage('${channelId}', '${docSnap.id}')" 
                                class="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-500 ml-2 p-1 transition-opacity">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        </button>
                    `;

                    // MEDIA RENDERING LOGIC
                    let contentHTML = '';
                    switch (msg.type) {
                        case 'image': 
                            contentHTML = `<img src="${msg.content}" class="max-w-[250px] rounded-lg mt-1 cursor-pointer"><p class="text-xs mt-1 text-gray-300">${msg.caption || ''}</p>`; 
                            break;
                        case 'audio': 
                            contentHTML = `
                                <div class="custom-audio-player mt-1">
                                    <button class="audio-play-pause-btn"><i data-lucide="play" class="w-4 h-4"></i></button>
                                    <div class="audio-timeline-container"><div class="audio-timeline-progress"></div></div>
                                    <span class="audio-time-display">0:00</span>
                                    <audio class="hidden-audio-element" src="${msg.content}" preload="metadata"></audio>
                                </div>`; 
                            break;
                        case 'document': 
                            contentHTML = `<div class="flex items-center gap-2 bg-black/20 p-2 rounded mt-1 border border-white/5"><i data-lucide="file-text" class="w-5 h-5 text-indigo-400"></i> <span class="truncate max-w-[200px]">${msg.fileName}</span></div>`; 
                            break;
                        case 'sticker': 
                            contentHTML = `<div class="text-6xl mt-1">${msg.content}</div>`; 
                            break;
                        default: 
                            contentHTML = `<div class="text-sm mt-1">${msg.text || '[Unsupported Media]'}</div>`;
                    }

                    // --- Helper (Put this at the top of your script if not already there) ---
                    const getShortId = (uid) => uid ? uid.slice(-4).toUpperCase() : '0000';

                    // --- Inside your message rendering loop ---
                    const div = document.createElement('div');
                    div.className = `flex gap-3 mb-4 group ${isMe ? 'flex-row-reverse' : ''}`;

                    // Determine the display name and moderation attributes
                    const actualUid = msg.senderId || msg.userId; // Check senderId first!
                    const studentCodename = `Student-${getShortId(actualUid)}`;
                    const nameDisplay = isMe ? window.currentMentor.name : studentCodename;

                    div.innerHTML = `
                        <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center text-sm ${msg.role === 'owner' || isMe ? 'bg-indigo-600' : 'bg-gray-600'}">
                            ${msg.role === 'owner' || isMe ? 'üõ°Ô∏è' : 'üë§'}
                        </div>
                        
                        <div class="flex flex-col max-w-[75%] ${isMe ? 'items-end' : 'items-start'}">
                            <div class="flex items-center mb-1">
                                <span class="text-xs font-bold text-gray-300 ${!isMe ? 'cursor-pointer hover:text-indigo-400 hover:underline transition-colors' : ''}" 
                                    ${!isMe ? `onclick="window.openModerationMenu('${actualUid}', '${studentCodename}')"` : ''}>
                                    ${nameDisplay}
                                </span>
                                ${msg.role === 'owner' || isMe ? '<span class="ml-2 bg-indigo-500 text-white text-[10px] px-1 rounded uppercase font-bold">STAFF</span>' : ''}
                                <span class="text-[10px] text-gray-500 ml-2">${timeStr}</span>
                                ${deleteBtn}
                            </div>
                            <div class="px-3 py-2 rounded-xl ${isMe ? 'bg-indigo-600/80 text-white rounded-tr-none' : 'bg-gray-700/50 text-gray-200 rounded-tl-none'}">
                                ${contentHTML}
                            </div>
                        </div>
                    `;
                    container.appendChild(div);

                    // Initialize Audio Player if this message is a voice note
                    const audioPlayer = div.querySelector('.custom-audio-player');
                    if (audioPlayer && typeof window.initializeAudioPlayer === 'function') {
                        window.initializeAudioPlayer(audioPlayer);
                    }
                });
                
                if(window.lucide) lucide.createIcons({ nodes: [container] });
                container.scrollTop = container.scrollHeight;
            });
        }

        // 6. Safe Event Binding & Missing Functions Injection
        setTimeout(() => {
            // 1. Hook up the text send button
            const sendBtn = document.getElementById('main-chat-send-btn');
            const chatInput = document.getElementById('main-chat-input');
            
            if (sendBtn && chatInput) {
                const newSendBtn = sendBtn.cloneNode(true);
                sendBtn.parentNode.replaceChild(newSendBtn, sendBtn);
                
                newSendBtn.addEventListener('click', () => {
                    if (chatInput.value.trim()) {
                        window.sendAdminMessageData({ type: 'text', text: chatInput.value.trim() });
                        chatInput.value = '';
                    }
                });

                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') newSendBtn.click();
                });
            }

            // 2. TURN ON THE MEDIA BUTTONS!
            initializeMentorMediaUI();

            // 3. Define the Audio Player initialization
            window.initializeAudioPlayer = function(playerElement) {
                // ... (Keep the rest of your audio player logic here)
                const audio = playerElement.querySelector('.hidden-audio-element');
                const playBtn = playerElement.querySelector('.audio-play-pause-btn');
                const playIcon = playBtn.querySelector('i');
                const timeline = playerElement.querySelector('.audio-timeline-container');
                const progress = playerElement.querySelector('.audio-timeline-progress');
                const timeDisplay = playerElement.querySelector('.audio-time-display');

                if (!audio) return; 

                const formatTime = (seconds) => {
                    const minutes = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
                    return `${minutes}:${secs}`;
                };

                audio.addEventListener('loadedmetadata', () => {
                    if (isFinite(audio.duration)) timeDisplay.textContent = `0:00 / ${formatTime(audio.duration)}`;
                });

                playBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (audio.paused) {
                        audio.play();
                        playIcon.setAttribute('data-lucide', 'pause');
                    } else {
                        audio.pause();
                        playIcon.setAttribute('data-lucide', 'play');
                    }
                    if(window.lucide) lucide.createIcons({ nodes: [playIcon] });
                });

                audio.addEventListener('timeupdate', () => {
                    const percent = (audio.currentTime / audio.duration) * 100;
                    progress.style.width = `${percent}%`;
                    if (isFinite(audio.duration)) timeDisplay.textContent = `${formatTime(audio.currentTime)} / ${formatTime(audio.duration)}`;
                });

                audio.addEventListener('ended', () => {
                    playIcon.setAttribute('data-lucide', 'play');
                    if(window.lucide) lucide.createIcons({ nodes: [playIcon] });
                    progress.style.width = '0%';
                });

                timeline.addEventListener('click', (e) => {
                    const rect = timeline.getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const percent = (clickX / rect.width);
                    if (isFinite(audio.duration)) audio.currentTime = percent * audio.duration;
                });
            }

        }, 1000);
        // =====================================================================
        // --- UI LOGIC: EMOJIS, ATTACHMENTS & MEDIA RECORDER ---
        // =====================================================================
        function initializeMentorMediaUI() {
            // 1. EMOJI PANEL LOGIC
            const emojiBtn = document.getElementById('emoji-btn');
            const emojiPanel = document.getElementById('emoji-panel');
            const emojisGrid = document.getElementById('emojis-grid');
            const stickersGrid = document.getElementById('stickers-grid');
            const chatInput = document.getElementById('main-chat-input');
            
            if (emojiBtn && emojiPanel) {
                // Populate Emojis & Stickers
                const emojis = ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá', 'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö', 'üòã', 'üòõ', 'üòù', 'üòú', 'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü§©', 'ü•≥', 'üòè', 'üòí', 'üòû', 'üòî', 'üòü', 'üòï', 'üôÅ', '‚òπÔ∏è', 'üò£', 'üòñ', 'üò´', 'üò©', 'ü•∫', 'üò¢', 'üò≠', 'üò§', 'üò†', 'üò°', 'ü§¨', 'ü§Ø', 'üò≥', 'ü•µ', 'ü•∂', 'üò±', 'üò®', 'üò∞', 'üò•', 'üòì', 'ü§ó', 'ü§î', 'ü§≠', 'ü§´', 'ü§•', 'üò∂', 'üòê', 'üòë', 'üò¨', 'üôÑ', 'üòØ', 'üò¶', 'üòß', 'üòÆ', 'üò≤', 'ü•±', 'üò¥', 'ü§§', 'üò™', 'üòµ', 'ü§ê', 'ü•¥', 'ü§¢', 'ü§Æ', 'ü§ß', 'üò∑', 'ü§í', 'ü§ï', 'ü§ë', 'ü§†', 'üòà', 'üëø', 'üëπ', 'üë∫', 'ü§°', 'üí©', 'üëª', 'üíÄ', '‚ò†Ô∏è', 'üëΩ', 'üëæ', 'ü§ñ', 'üéÉ'];
                const stickers = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üôè', 'üî•', 'üéâ', 'üíØ', 'üëã', 'üõ°Ô∏è', '‚úÖ', '‚ö†Ô∏è'];
                
                if(emojisGrid) emojisGrid.innerHTML = emojis.map(e => `<button class="emoji-btn">${e}</button>`).join('');
                if(stickersGrid) stickersGrid.innerHTML = stickers.map(s => `<button class="sticker-btn">${s}</button>`).join('');

                // Toggle Panel
                emojiBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (emojiPanel.classList.contains('hidden')) {
                        emojiPanel.classList.remove('hidden');
                        setTimeout(() => emojiPanel.classList.remove('scale-90', 'opacity-0'), 10);
                    } else {
                        emojiPanel.classList.add('scale-90', 'opacity-0');
                        setTimeout(() => emojiPanel.classList.add('hidden'), 200);
                    }
                });

                // Close on outside click
                document.addEventListener('click', (e) => {
                    if (!emojiPanel.classList.contains('hidden') && !emojiPanel.contains(e.target) && e.target !== emojiBtn) {
                        emojiPanel.classList.add('scale-90', 'opacity-0');
                        setTimeout(() => emojiPanel.classList.add('hidden'), 200);
                    }
                });

                // Handle Clicks (Insert Emoji / Send Sticker / Switch Tabs)
                emojiPanel.addEventListener('click', (e) => {
                    if (e.target.matches('.emoji-btn')) {
                        chatInput.value += e.target.textContent;
                        chatInput.focus();
                    }
                    if (e.target.matches('.sticker-btn')) {
                        window.sendAdminMessageData({ type: 'sticker', content: e.target.textContent });
                        emojiPanel.classList.add('scale-90', 'opacity-0');
                        setTimeout(() => emojiPanel.classList.add('hidden'), 200);
                    }
                    if (e.target.matches('.emoji-tab')) {
                        emojiPanel.querySelectorAll('.emoji-tab').forEach(t => t.classList.remove('active', 'border-indigo-500'));
                        e.target.classList.add('active', 'border-indigo-500');
                        if (e.target.dataset.tab === 'emojis') {
                            emojisGrid.classList.remove('hidden');
                            stickersGrid.classList.add('hidden');
                        } else {
                            emojisGrid.classList.add('hidden');
                            stickersGrid.classList.remove('hidden');
                        }
                    }
                });
            }

            // 2. ATTACHMENT MENU LOGIC
            const attachBtn = document.getElementById('attachment-btn');
            const attachMenu = document.getElementById('attachment-menu');
            
            if (attachBtn && attachMenu) {
                attachBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (attachMenu.classList.contains('hidden')) {
                        attachMenu.classList.remove('hidden');
                        setTimeout(() => {
                            attachMenu.classList.remove('scale-90', 'opacity-0');
                            attachBtn.style.transform = 'rotate(45deg)';
                        }, 10);
                    } else {
                        attachMenu.classList.add('scale-90', 'opacity-0');
                        attachBtn.style.transform = 'rotate(0deg)';
                        setTimeout(() => attachMenu.classList.add('hidden'), 200);
                    }
                });

                document.addEventListener('click', (e) => {
                    if (!attachMenu.classList.contains('hidden') && !attachMenu.contains(e.target) && e.target !== attachBtn) {
                        attachMenu.classList.add('scale-90', 'opacity-0');
                        attachBtn.style.transform = 'rotate(0deg)';
                        setTimeout(() => attachMenu.classList.add('hidden'), 200);
                    }
                });
                
                // 3. IMAGE UPLOAD
                const imageInput = document.getElementById('image-upload-input');
                const attachImageBtn = document.getElementById('attach-image-btn');
                const previewModal = document.getElementById('image-preview-modal');
                const previewImg = document.getElementById('preview-image');
                let currentImageFile = null;

                if(attachImageBtn && imageInput) {
                    attachImageBtn.addEventListener('click', () => imageInput.click());
                    imageInput.addEventListener('change', (e) => {
                        if (e.target.files && e.target.files[0]) {
                            currentImageFile = e.target.files[0];
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                previewImg.src = event.target.result;
                                previewModal.classList.remove('hidden');
                                previewModal.style.display = 'flex'; // Force flex
                                
                                // Auto-close attachment menu
                                attachMenu.classList.add('scale-90', 'opacity-0');
                                attachBtn.style.transform = 'rotate(0deg)';
                                setTimeout(() => attachMenu.classList.add('hidden'), 200);
                            };
                            reader.readAsDataURL(currentImageFile);
                        }
                    });
                }
                
                const sendImgBtn = document.getElementById('send-image-btn');
                const cancelImgBtn = document.getElementById('cancel-image-btn');
                const captionInput = document.getElementById('image-caption-input');
                
                if (cancelImgBtn) {
                    cancelImgBtn.addEventListener('click', () => {
                        previewModal.classList.add('hidden');
                        previewModal.style.display = 'none';
                        if(captionInput) captionInput.value = '';
                        if(imageInput) imageInput.value = '';
                        currentImageFile = null;
                    });
                }
                
                if (sendImgBtn) {
                    sendImgBtn.addEventListener('click', () => {
                        if (!currentImageFile) return;
                        const caption = captionInput ? captionInput.value.trim() : '';
                        window.sendAdminMessageData({ type: 'image', content: previewImg.src, caption: caption });
                        cancelImgBtn.click(); // Close and reset
                    });
                }

                // 4. DOCUMENT UPLOAD
                const docInput = document.getElementById('doc-upload-input');
                const attachDocBtn = document.getElementById('attach-doc-btn');
                if (attachDocBtn && docInput) {
                    attachDocBtn.addEventListener('click', () => docInput.click());
                    docInput.addEventListener('change', (e) => {
                        if (e.target.files && e.target.files[0]) {
                            const docFile = e.target.files[0];
                            window.sendAdminMessageData({ type: 'document', fileName: docFile.name });
                            docInput.value = '';
                            
                            attachMenu.classList.add('scale-90', 'opacity-0');
                            attachBtn.style.transform = 'rotate(0deg)';
                            setTimeout(() => attachMenu.classList.add('hidden'), 200);
                        }
                    });
                }

                // 5. VOICE RECORDER
                const recordVoiceBtn = document.getElementById('record-voice-btn');
                const voiceContainer = document.getElementById('voice-recorder-container');
                let mediaRecorder = null;
                let audioChunks = [];
                let isRecording = false;

                if (recordVoiceBtn && voiceContainer) {
                    recordVoiceBtn.addEventListener('click', async () => {
                        attachMenu.classList.add('scale-90', 'opacity-0');
                        attachBtn.style.transform = 'rotate(0deg)';
                        setTimeout(() => attachMenu.classList.add('hidden'), 200);

                        if (isRecording) return;
                        
                        try {
                            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                            mediaRecorder = new MediaRecorder(stream);
                            audioChunks = [];
                            
                            mediaRecorder.addEventListener("dataavailable", event => { audioChunks.push(event.data); });
                            mediaRecorder.addEventListener("stop", () => {
                                if (audioChunks.length > 0) {
                                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                                    const reader = new FileReader();
                                    reader.onload = (event) => {
                                        window.sendAdminMessageData({ type: 'audio', content: event.target.result });
                                    };
                                    reader.readAsDataURL(audioBlob);
                                }
                                voiceContainer.innerHTML = ''; 
                                isRecording = false;
                                stream.getTracks().forEach(track => track.stop()); 
                            });

                            // Build UI
                            voiceContainer.innerHTML = `
                                <div class="glass p-2 rounded-lg flex items-center justify-between mb-2 border border-red-500/50 bg-red-900/20">
                                    <div class="flex items-center gap-2 text-red-400 animate-pulse">
                                        <i data-lucide="mic" class="w-5 h-5"></i> <span class="text-sm font-bold tracking-widest">RECORDING...</span>
                                    </div>
                                    <div class="flex gap-2">
                                        <button id="cancel-record-btn" class="p-2 bg-gray-700 hover:bg-red-600 rounded-full text-white transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                        <button id="send-record-btn" class="p-2 bg-indigo-600 hover:bg-indigo-500 rounded-full text-white transition-colors"><i data-lucide="send" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                            `;
                            if(window.lucide) lucide.createIcons({ nodes: [voiceContainer] });

                            document.getElementById('cancel-record-btn').addEventListener('click', () => {
                                audioChunks = []; 
                                mediaRecorder.stop();
                            });

                            document.getElementById('send-record-btn').addEventListener('click', () => {
                                mediaRecorder.stop();
                            });

                            mediaRecorder.start();
                            isRecording = true;

                        } catch (err) {
                            console.error("Mic error:", err);
                            alert("Could not access microphone.");
                        }
                    });
                }
            }
        }
    </script>
    <div id="mod-menu" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[200]">
        <div class="glass max-w-xs w-full p-6 rounded-2xl border border-white/10 shadow-2xl">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-indigo-600/20 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i data-lucide="shield-alert" class="w-8 h-8 text-indigo-400"></i>
                </div>
                <h3 id="mod-user-display" class="text-xl font-bold text-white">Student-XXXX</h3>
                <p id="mod-user-id" class="text-[10px] text-gray-500 font-mono mt-1"></p>
            </div>

            <div class="space-y-2">
                <button onclick="applyTimeout(10)" class="w-full py-3 px-4 bg-yellow-600/20 hover:bg-yellow-600 text-yellow-400 hover:text-white rounded-xl border border-yellow-600/30 transition-all flex items-center justify-between">
                    <span class="font-bold">Timeout 10m</span>
                    <i data-lucide="timer" class="w-4 h-4"></i>
                </button>
                
                <button onclick="applyTimeout(1440)" class="w-full py-3 px-4 bg-orange-600/20 hover:bg-orange-600 text-orange-400 hover:text-white rounded-xl border border-orange-600/30 transition-all flex items-center justify-between">
                    <span class="font-bold">Timeout 24h</span>
                    <i data-lucide="clock" class="w-4 h-4"></i>
                </button>

                <button onclick="closeModMenu()" class="w-full py-2 text-gray-400 hover:text-white text-sm mt-4">Cancel</button>
            </div>
        </div>
    </div>
</body>
</html>