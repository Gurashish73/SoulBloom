<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soul Bloom | Mentor Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0c1a1e; color: #e2e8f0; }
        .font-playfair { font-family: 'Playfair Display', serif; }
        .glass { background: rgba(17, 24, 39, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        
        #garden-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none; }
        .leaf { position: absolute; width: 30px; height: 30px; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" fill="%2322c55e" viewBox="0 0 24 24"><path d="M17 8C8 10 5.9 16.17 3.82 21.34L5.71 22L6.66 19.7C7.14 18.45 7.93 17.37 8.95 16.54C10 15.64 11.22 15 12.5 15H17V12H12.5C11.54 12 10.64 11.73 9.84 11.23C9.04 10.73 8.36 10.05 7.85 9.24C7.05 7.94 6.75 6.45 7 5C7.25 3.55 8.06 2.22 9.24 1.28L10.47 2.5L9.5 3.47C9.06 3.91 8.72 4.45 8.5 5C8.25 5.55 8.12 6.16 8.12 6.79C8.12 7.41 8.25 8.03 8.5 8.5C8.72 9.05 9.06 9.59 9.5 10.03L10.47 11L17 11V8Z"/></svg>'); background-size: contain; opacity: 0.1; animation: float 20s infinite linear; }
        @keyframes float { 0% { transform: translateY(100vh) rotate(0deg); } 100% { transform: translateY(-20vh) rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="garden-bg"></div>

    <header class="sticky top-0 z-50 w-full glass border-b border-white/10">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i data-lucide="sprout" class="w-8 h-8 text-green-400"></i>
                <span class="text-2xl font-bold font-playfair text-white">Soul Bloom <span class="text-base font-sans font-normal text-gray-400 ml-2">| Mentor Console</span></span>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="window.clearMockData()" class="hidden md:block bg-gray-600/20 border border-gray-500 text-gray-300 hover:bg-gray-600 hover:text-white px-3 py-1 rounded text-xs font-bold transition">
                    <i data-lucide="trash-2" class="w-3 h-3 inline mr-1"></i> Clear Data
                </button>
                <button onclick="window.simulateGraphData()" class="hidden md:block bg-blue-600/20 border border-blue-500 text-blue-300 hover:bg-blue-600 hover:text-white px-3 py-1 rounded text-xs font-bold transition">
                    + Simulate Reports
                </button>
                <button onclick="window.simulateFlag()" class="hidden md:block bg-red-600/20 border border-red-500 text-red-300 hover:bg-red-600 hover:text-white px-3 py-1 rounded text-xs font-bold transition">
                    + Simulate Alert
                </button>
                
                <div class="flex items-center gap-2 text-sm text-green-400 bg-green-900/30 px-3 py-1 rounded-full border border-green-500/30">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                    </span>
                    <span class="hidden sm:inline">Live System</span>
                </div>

                <button onclick="logout()" class="bg-gray-700 hover:bg-red-600 text-white p-2 rounded-full transition-colors duration-300" title="Sign Out">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-6 flex-1">
        
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-white mb-2">Campus Wellness Overview</h1>
            <p class="text-gray-400">Real-time insights from student screenings and check-ins.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="glass rounded-xl p-6 border-l-4 border-blue-500">
                <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wider">Total Reports</h3>
                <p class="text-4xl font-bold text-white mt-2" id="stat-reports">Loading...</p>
                <div class="text-xs text-blue-400 mt-2" id="stat-reports-label">Filtered View</div>
            </div>
            
            <div class="glass rounded-xl p-6 border-l-4 border-yellow-500">
                <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wider">Avg Anxiety Score</h3>
                <p class="text-4xl font-bold text-white mt-2" id="stat-anxiety">...</p>
                <div class="text-xs text-yellow-400 mt-2">Based on GAD-7</div>
            </div>

            <div class="glass rounded-xl p-6 border-l-4 border-green-500">
                <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wider">Avg Mood Score</h3>
                <p class="text-4xl font-bold text-white mt-2" id="stat-mood">...</p>
                <div class="text-xs text-green-400 mt-2">Inverse PHQ-9 metric</div>
            </div>

            <div class="glass rounded-xl p-6 border-l-4 border-red-500">
                <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wider">Active Alerts</h3>
                <p class="text-4xl font-bold text-white mt-2" id="stat-alerts">...</p>
                <div class="text-xs text-red-400 mt-2" id="alert-subtext">Requires attention</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            
            <div class="lg:col-span-2 glass rounded-xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-white">Student Mental Health Distribution</h3>
                    <select id="time-filter" onchange="window.filterAnalytics(this.value)" class="bg-black/30 border border-white/10 rounded px-3 py-1 text-sm text-gray-300 focus:outline-none focus:border-green-500 cursor-pointer">
                        <option value="today">Today</option>
                        <option value="7days">Last 7 Days</option>
                        <option value="30days" selected>Last 30 Days</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
                <div class="h-64">
                    <canvas id="wellnessChart"></canvas>
                </div>
            </div>

            <div class="glass rounded-xl p-6 flex flex-col gap-4">
                <h3 class="text-xl font-bold text-white mb-2">Quick Actions</h3>
                
                <div class="bg-black/20 p-4 rounded-lg border border-white/5">
                    <h4 class="text-sm font-bold text-blue-300 mb-2 flex items-center gap-2">
                        <i data-lucide="calendar-plus" class="w-4 h-4"></i> Open Appointment Slot
                    </h4>
                    <div class="flex gap-2">
                        <input type="datetime-local" id="appt-date" class="w-full bg-black/40 border border-white/10 rounded px-2 py-1 text-sm text-white focus:outline-none focus:border-blue-500">
                        <button onclick="addAppointmentSlot()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-bold">+</button>
                    </div>
                    <p id="appt-msg" class="text-xs text-green-400 mt-1 hidden">Slot Added!</p>
                </div>

                <div class="bg-black/20 p-4 rounded-lg border border-white/5">
                    <h4 class="text-sm font-bold text-purple-300 mb-2 flex items-center gap-2">
                        <i data-lucide="book-plus" class="w-4 h-4"></i> Add Resource Link
                    </h4>
                    <input type="text" id="res-title" placeholder="Resource Title" class="w-full bg-black/40 border border-white/10 rounded px-2 py-1 text-sm text-white mb-2 focus:outline-none focus:border-purple-500">
                    <div class="flex gap-2">
                        <input type="text" id="res-url" placeholder="URL" class="w-full bg-black/40 border border-white/10 rounded px-2 py-1 text-sm text-white focus:outline-none focus:border-purple-500">
                        <button onclick="addResource()" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm font-bold">+</button>
                    </div>
                    <p id="res-msg" class="text-xs text-green-400 mt-1 hidden">Resource Added!</p>
                </div>
            </div>
        </div>

        <div class="glass rounded-xl p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-red-400 flex items-center gap-2">
                    <i data-lucide="shield-alert" class="w-5 h-5"></i> Flagged Content Review
                </h3>
                <span class="text-xs bg-red-900/30 text-red-300 px-2 py-1 rounded border border-red-500/30">Priority High</span>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="text-xs text-gray-400 uppercase bg-black/20 border-b border-white/10">
                        <tr>
                            <th class="px-4 py-3">Timestamp</th>
                            <th class="px-4 py-3">User ID</th>
                            <th class="px-4 py-3">Trigger Content</th>
                            <th class="px-4 py-3">Action</th>
                        </tr>
                    </thead>
                    <tbody id="flagged-table-body" class="text-sm text-gray-300 divide-y divide-white/5">
                        <tr>
                            <td colspan="4" class="px-4 py-8 text-center text-gray-500">Connecting to live feed...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <div id="report-viewer-section" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[100]">
        <div class="bg-gray-900 rounded-lg border border-gray-700 shadow-2xl max-w-2xl w-full p-6 m-4 relative">
            <button onclick="document.getElementById('report-viewer-section').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <div class="mb-4 border-b border-gray-700 pb-4">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    <i data-lucide="file-text" class="w-5 h-5 text-blue-400"></i> Student Health Report
                </h2>
            </div>
            <div id="single-report-content" class="space-y-4">
                </div>
        </div>
    </div>

    <div id="resolve-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-[110]">
        <div class="glass max-w-md w-full p-6 rounded-2xl border border-red-500/30 shadow-[0_0_50px_rgba(220,38,38,0.2)]">
            <div class="flex items-center gap-3 mb-4 text-red-400 border-b border-white/10 pb-4">
                <div class="p-2 bg-red-500/20 rounded-lg">
                    <i data-lucide="siren" class="w-6 h-6"></i>
                </div>
                <h2 class="text-xl font-bold">Crisis Resolution Center</h2>
            </div>
            
            <p class="text-sm text-gray-400 mb-6">Select an immediate action for Student <span id="res-student-id" class="text-white font-mono">...</span></p>

            <div class="space-y-3">
                <button onclick="performAction('remind')" class="w-full flex items-center justify-between p-4 rounded-xl bg-gray-800 hover:bg-gray-700 border border-white/10 transition-all group">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-blue-500/20 rounded-lg text-blue-400"><i data-lucide="bell-ring" class="w-5 h-5"></i></div>
                        <div class="text-left">
                            <div class="font-bold text-gray-200">Send Check-in Reminder</div>
                            <div class="text-xs text-gray-500">Nudge student to update journal</div>
                        </div>
                    </div>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-600 group-hover:text-white"></i>
                </button>

                <button onclick="performAction('book')" class="w-full flex items-center justify-between p-4 rounded-xl bg-gray-800 hover:bg-gray-700 border border-white/10 transition-all group">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-purple-500/20 rounded-lg text-purple-400"><i data-lucide="calendar-check" class="w-5 h-5"></i></div>
                        <div class="text-left">
                            <div class="font-bold text-gray-200">Book Priority Session</div>
                            <div class="text-xs text-gray-500">Schedule immediate 1:1 meeting</div>
                        </div>
                    </div>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-600 group-hover:text-white"></i>
                </button>

                <button onclick="performAction('resolve')" class="w-full flex items-center justify-between p-4 rounded-xl bg-gray-800 hover:bg-green-900/30 border border-white/10 hover:border-green-500/50 transition-all group">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-green-500/20 rounded-lg text-green-400"><i data-lucide="check-circle-2" class="w-5 h-5"></i></div>
                        <div class="text-left">
                            <div class="font-bold text-gray-200 group-hover:text-green-300">Mark as Resolved</div>
                            <div class="text-xs text-gray-500 group-hover:text-green-400/70">Archive this alert</div>
                        </div>
                    </div>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-600 group-hover:text-white"></i>
                </button>
            </div>

            <button onclick="closeResolveModal()" class="mt-6 w-full py-2 text-sm text-gray-500 hover:text-white transition">Cancel</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, getDocs, where, addDoc, deleteDoc, serverTimestamp, orderBy, limit, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBq0HjzNJxwBrRGpn3TXFdUiOK-ye5fl44",
            authDomain: "soulbloom-5ee07.firebaseapp.com",
            projectId: "soulbloom-5ee07",
            storageBucket: "soulbloom-5ee07.firebasestorage.app",
            messagingSenderId: "713116806966",
            appId: "1:713116806966:web:2f0ca2b5a4736f5816cd97",
            measurementId: "G-17068CTD2S"
        };

        const sanitizedAppId = 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // GLOBALS
        let allReports = []; 
        let currentFlagId = null;
        let currentStudentId = null;

        // --- 1. DATA FETCHING ---
        async function fetchAnalytics() {
            try {
                const reportsRef = collection(db, `artifacts/${sanitizedAppId}/public/data/mental_health_reports`);
                onSnapshot(reportsRef, (snapshot) => {
                    allReports = [];
                    snapshot.forEach(doc => allReports.push(doc.data()));
                    const currentFilter = document.getElementById('time-filter').value;
                    filterAnalytics(currentFilter);
                });
            } catch (e) { console.error("Analytics Error:", e); }
        }

        window.filterAnalytics = (range) => {
            if (!allReports.length) {
                document.getElementById('stat-reports').innerText = "0";
                return;
            }
            const now = new Date();
            let cutoffDate = new Date(0); 
            if (range === 'today') { cutoffDate = new Date(); cutoffDate.setHours(0, 0, 0, 0); } 
            else if (range === '7days') { cutoffDate.setDate(now.getDate() - 7); } 
            else if (range === '30days') { cutoffDate.setDate(now.getDate() - 30); }

            const filteredData = allReports.filter(r => {
                if (!r.createdAt) return false;
                const rDate = r.createdAt.toDate ? r.createdAt.toDate() : new Date(r.createdAt);
                return rDate >= cutoffDate;
            });
            processStats(filteredData);
        };

        function processStats(data) {
            let totalPHQ = 0, totalGAD = 0;
            let severity = { normal: 0, mild: 0, moderate: 0, severe: 0 };
            data.forEach(r => {
                const p = r.phqScore || 0;
                totalPHQ += p;
                totalGAD += (r.gadScore || 0);
                if (p < 5) severity.normal++;
                else if (p < 10) severity.mild++;
                else if (p < 15) severity.moderate++;
                else severity.severe++;
            });
            const total = data.length;
            const avgPHQ = total > 0 ? (totalPHQ / total).toFixed(1) : 0;
            const avgGAD = total > 0 ? (totalGAD / total).toFixed(1) : 0;
            document.getElementById('stat-reports').innerText = total;
            document.getElementById('stat-anxiety').innerText = avgGAD; 
            document.getElementById('stat-mood').innerText = total > 0 ? (27 - avgPHQ).toFixed(1) : "-";
            updateChart(severity);
        }

        // --- 2. CHART ---
        let wellnessChartInstance = null;
        function updateChart(data) {
            const ctx = document.getElementById('wellnessChart').getContext('2d');
            if(wellnessChartInstance) wellnessChartInstance.destroy();
            wellnessChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Thriving', 'Mild Stress', 'Moderate', 'Critical'],
                    datasets: [{
                        label: 'Student Count',
                        data: [data.normal, data.mild, data.moderate, data.severe],
                        backgroundColor: ['rgba(34, 197, 94, 0.6)', 'rgba(234, 179, 8, 0.6)', 'rgba(249, 115, 22, 0.6)', 'rgba(239, 68, 68, 0.6)'],
                        borderColor: ['rgb(34, 197, 94)', 'rgb(234, 179, 8)', 'rgb(249, 115, 22)', 'rgb(239, 68, 68)'],
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#9ca3af' } }, x: { grid: { display: false }, ticks: { color: '#9ca3af' } } } }
            });
        }

        // --- 3. FLAGGED USERS ---
        function listenForFlags() {
            const flagsRef = collection(db, `artifacts/${sanitizedAppId}/public/data/flagged_users`);
            const q = query(flagsRef, limit(15));
            onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('flagged-table-body');
                document.getElementById('stat-alerts').innerText = snapshot.size; 
                if (snapshot.empty) { tbody.innerHTML = `<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">No active alerts.</td></tr>`; return; }
                let html = '';
                const docs = [];
                snapshot.forEach(doc => docs.push({ id: doc.id, ...doc.data() }));
                docs.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                docs.forEach(d => {
                    const date = d.timestamp?.toDate ? d.timestamp.toDate().toLocaleString() : 'Just now';
                    html += `
                        <tr class="hover:bg-white/5 transition border-b border-white/5" id="row-${d.id}">
                            <td class="px-4 py-3 text-gray-400 font-mono text-xs">${date}</td>
                            <td class="px-4 py-3 font-mono text-xs text-blue-300">${d.userId.substring(0,8)}...</td>
                            <td class="px-4 py-3 text-gray-200 italic">"${d.message}"</td>
                            <td class="px-4 py-3">
                                <div class="flex items-center gap-2">
                                    <button onclick="window.checkReport('${d.userId}')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-2 py-1 rounded text-xs font-bold">View Report</button>
                                    <button onclick="window.openResolveModal('${d.id}', '${d.userId}')" class="bg-red-600/80 hover:bg-red-500 text-white px-3 py-1 rounded text-xs font-bold shadow-lg shadow-red-900/20">Take Action</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                tbody.innerHTML = html;
            });
        }

        // --- 4. VIEW REPORT ---
        window.checkReport = async (userId) => {
            const reportsRef = collection(db, `artifacts/${sanitizedAppId}/public/data/mental_health_reports`);
            const q = query(reportsRef, where("userId", "==", userId)); // Client sort again
            const snapshot = await getDocs(q);
            const contentDiv = document.getElementById('single-report-content');
            const modal = document.getElementById('report-viewer-section');
            if (!snapshot.empty) {
                const docs = snapshot.docs.map(d => d.data());
                docs.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                const data = docs[0];
                const reportDate = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString() : 'N/A';
                contentDiv.innerHTML = `<div class="grid grid-cols-2 gap-4 text-sm text-gray-300 mb-4 bg-black/20 p-3 rounded"><div><strong>User ID:</strong> <span class="font-mono text-blue-300">${data.userId}</span></div><div><strong>Date:</strong> ${reportDate}</div></div><div class="grid grid-cols-2 gap-4 text-sm mb-4"><div class="bg-black/40 p-3 rounded border border-white/5"><span class="text-gray-400 block text-xs uppercase mb-1">Depression (PHQ-9)</span><span class="font-bold text-xl ${data.phqScore > 9 ? 'text-red-400' : 'text-green-400'}">${data.phqScore}</span> / 27</div><div class="bg-black/40 p-3 rounded border border-white/5"><span class="text-gray-400 block text-xs uppercase mb-1">Anxiety (GAD-7)</span><span class="font-bold text-xl ${data.gadScore > 9 ? 'text-red-400' : 'text-green-400'}">${data.gadScore}</span> / 21</div></div><div class="bg-black/40 p-4 rounded text-gray-300 text-sm whitespace-pre-wrap border-l-2 border-blue-500">${data.report}</div>`;
            } else { contentDiv.innerHTML = `<div class="text-center py-8"><p class="text-yellow-400 mb-2">No screening report found.</p><p class="text-xs text-gray-500">Likely Chat Analysis Flag.</p></div>`; }
            modal.classList.remove('hidden');
        };

        // --- 5. NEW: RESOLUTION MODAL LOGIC ---
        window.openResolveModal = (flagId, userId) => {
            currentFlagId = flagId;
            currentStudentId = userId;
            document.getElementById('res-student-id').innerText = userId.substring(0, 8) + '...';
            document.getElementById('resolve-modal').classList.remove('hidden');
        };

        window.closeResolveModal = () => {
            document.getElementById('resolve-modal').classList.add('hidden');
            currentFlagId = null;
            currentStudentId = null;
        };

        window.performAction = async (actionType) => {
            if (!currentStudentId || !currentFlagId) return;
            const btn = event.currentTarget;
            btn.innerHTML = `<div class="flex items-center gap-2"><div class="animate-spin h-4 w-4 border-2 border-white rounded-full border-t-transparent"></div> Processing...</div>`;

            try {
                if (actionType === 'remind') {
                    // Send Notification to Student
                    await addDoc(collection(db, `artifacts/${sanitizedAppId}/users/${currentStudentId}/notifications`), {
                        title: "Wellness Check-in",
                        message: "Dr. Evans noticed you might be stressed. Please fill out your journal today.",
                        type: "reminder",
                        createdAt: serverTimestamp()
                    });
                    alert("Notification Sent to Student Dashboard!");
                
                } else if (actionType === 'book') {
                    // Create Booked Appointment
                    const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1); tomorrow.setHours(10, 0, 0, 0);
                    await addDoc(collection(db, `artifacts/${sanitizedAppId}/public/data/appointments`), {
                        startTime: tomorrow,
                        status: 'booked',
                        mentorName: "Dr. Evans (Priority)",
                        studentId: currentStudentId,
                        createdAt: serverTimestamp()
                    });
                    alert("Priority Session Booked for Tomorrow at 10 AM!");
                
                } else if (actionType === 'resolve') {
                    // Delete Flag
                    await deleteDoc(doc(db, `artifacts/${sanitizedAppId}/public/data/flagged_users/${currentFlagId}`));
                    // Also delete from table visually immediately
                    const row = document.getElementById(`row-${currentFlagId}`);
                    if (row) row.remove();
                }
                
                window.closeResolveModal();

            } catch (e) {
                console.error("Action Error:", e);
                alert("Action Failed: " + e.message);
                btn.innerHTML = "Try Again";
            }
        };

        // --- 6. OTHER HANDLERS ---
        window.addAppointmentSlot = async () => { /* ... existing logic ... */ };
        window.addResource = async () => { /* ... existing logic ... */ };
        window.simulateFlag = async () => {
            const messages = ["Overwhelmed with exams.", "Feeling very low.", "Academic stress is too much.", "Sleepless nights due to anxiety."];
            const mockUserId = "test-user-" + Math.floor(Math.random()*1000);
            try {
                await addDoc(collection(db, `artifacts/${sanitizedAppId}/public/data/flagged_users`), { userId: mockUserId, message: messages[Math.floor(Math.random() * messages.length)], timestamp: serverTimestamp() });
                await addDoc(collection(db, `artifacts/${sanitizedAppId}/public/data/mental_health_reports`), { userId: mockUserId, phqScore: 18, gadScore: 15, report: "Auto-generated report.", createdAt: serverTimestamp() });
            } catch(e) { console.error(e); }
        };
        window.simulateGraphData = async () => { /* ... existing logic ... */ };
        window.clearMockData = async () => { /* ... existing logic ... */ };
        window.logout = () => { auth.signOut().then(() => window.location.href = '../index.html'); }

        onAuthStateChanged(auth, (user) => { if(user) { fetchAnalytics(); listenForFlags(); const bg = document.getElementById('garden-bg'); for(let i=0; i<15; i++) { const leaf = document.createElement('div'); leaf.className = 'leaf'; leaf.style.left = Math.random() * 100 + 'vw'; leaf.style.animationDuration = (15 + Math.random() * 15) + 's'; leaf.style.animationDelay = (Math.random() * 10) + 's'; bg.appendChild(leaf); } } else { signInAnonymously(auth).catch(e => console.error(e)); } });
        lucide.createIcons();
    </script>
</body>
</html>